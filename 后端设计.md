# **校园二手交易平台**的后端设计

结合Python和MySQL技术栈，严格遵循实验对数据库完整性、事务处理以及页面逻辑的要求

---

## 一、数据库逻辑模型设计 (MySQL)

后端的核心是数据的持久化存储。根据实验要求，我们需要设计以下核心表结构：

### 1. 用户表 (`Users`)
- **UserID**：自增主键
- **Username**：唯一约束，用于登录
- **PasswordHash**：存储加密后的密码，严禁明文
- **Email/Phone**：用户联系方式，注册时需校验格式

### 2. 商品表 (`Items`)
- **ItemID**：自增主键
- **Title**：商品名称，支持非大小写敏感搜索
- **Description**：商品详细描述
- **Price**：商品单价
- **Stock**：**关键字段**，记录当前库存数量
- **SellerID**：外键，关联`Users.UserID`，标明发布者

### 3. 订单表 (`Orders`)
- **OrderID**：主键
- **BuyerID**：外键，关联`Users.UserID`
- **OrderDate**：下单时间
- **ShippingAddress**：配送地址信息
- **TotalAmount**：订单总金额

### 4. 订单明细表 (`Order_Items`)
- 用于处理一个订单包含多个商品的情况（虽然二手物品多为1件，但系统设计需具备通用性）
- 包含`OrderID`、`ItemID`、`Quantity`、`PriceAtPurchase`

---

## 二、核心业务逻辑实现规划

后端逻辑层（Application Layer）需要处理各页面背后的数据请求与校验

### 1. 身份认证与会话管理（对应登录/注册页）
- **注册校验**：在写入数据库前，必须检查用户名是否已存在、必填项是否缺失
- **登录维持**：验证成功后，后端需在浏览器创建**Cookie**。后续敏感操作（如结账）必须校验该Cookie以确认用户身份

### 2. 搜索逻辑（对应搜索页）
- **SQL实现**：使用`SELECT * FROM Items WHERE Title LIKE %search_str%`
- **规范**：利用MySQL的`LOWER()`函数或默认的排序规则（Collation）实现**非大小写敏感**的检索

### 3. 临时购物车逻辑（对应购物车页）
- **临时性要求**：系统不得将购物车信息永久存入数据库
- **后端方案**：建议使用Python的`Session`对象或前端`localStorage`。后端仅在用户请求购物车页面时，从内存/缓存中读取并计算各项小计

### 4. 结账事务与库存控制（对应结账页）

这是整个后端设计中最关键的部分，必须满足"操作成功扣减库存，不足则报错"的要求：

1. **开启事务 (Transaction)**：确保操作的原子性
2. **库存检查**：查询`Items`表，核对`Stock`是否大于等于购买数量
3. **库存扣减**：执行`UPDATE Items SET Stock = Stock - ? WHERE ItemID = ?`
4. **生成订单**：向`Orders`和`Order_Items`表插入记录
5. **提交或回滚**：若上述任何一步失败（如库存不足），必须回滚事务并向前端返回错误消息

---

## 三、技术规范与安全性
- **API规范**：建议采用RESTful风格（如`POST /api/login`，`GET /api/items/<id>`）
- **错误处理**：对于无效的输入（如注册信息不完整），后端需返回明确的错误码和提示
- **环境要求**：建议在VMware的Ubuntu环境下部署Python环境，并连接MySQL数据库进行实机测试