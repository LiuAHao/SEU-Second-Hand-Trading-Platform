# åç«¯å®ç°å¿«é€Ÿå‚è€ƒ

## ğŸ“‹ æ ¸å¿ƒæ•°æ®è¡¨ï¼ˆ6ä¸ªï¼‰

| è¡¨å | è¯´æ˜ | å…³é”®å­—æ®µ | ç”¨é€” |
|------|------|--------|------|
| **users** | ç”¨æˆ· | id, username, email, password_hash | ç”¨æˆ·è®¤è¯ã€èµ„æ–™ |
| **items** | å•†å“ | id, seller_id, title, price, **stock** | å•†å“ç®¡ç†ã€åº“å­˜ |
| **orders** | è®¢å• | id, buyer_id, total_amount, status | è®¢å•è®°å½• |
| **order_items** | è®¢å•æ˜ç»† | order_id, item_id, quantity, price_at_purchase | è®¢å•è¯¦æƒ… |
| **addresses** | é…é€åœ°å€ | user_id, detail, is_default | åœ°å€ç®¡ç† |
| **reviews** | è¯„ä»· | item_id, reviewer_id, rating, content | ç”¨æˆ·è¯„ä»· |

---

## ğŸ”‘ å…³é”®APIæ¥å£ï¼ˆ18ä¸ªï¼‰

### ç”¨æˆ·æ¨¡å—ï¼ˆ8ä¸ªï¼‰
```
POST   /api/auth/register              æ³¨å†Œç”¨æˆ·
POST   /api/auth/login                 ç™»å½•
POST   /api/auth/logout                ç™»å‡º
GET    /api/users/current              è·å–å½“å‰ç”¨æˆ·
GET    /api/users/{userId}/profile     è·å–ç”¨æˆ·èµ„æ–™
PUT    /api/users/profile              æ›´æ–°èµ„æ–™
GET    /api/users/check-username       æ£€æŸ¥ç”¨æˆ·å
GET    /api/users/check-email          æ£€æŸ¥é‚®ç®±
```

### å•†å“æ¨¡å—ï¼ˆ8ä¸ªï¼‰
```
POST   /api/items                      å‘å¸ƒå•†å“
GET    /api/items/featured             é¦–é¡µæ¨è
GET    /api/items/search               æœç´¢å•†å“
GET    /api/items/category/{cat}       åˆ†ç±»æµè§ˆ
GET    /api/items/{itemId}             å•†å“è¯¦æƒ…
PUT    /api/items/{itemId}             æ›´æ–°å•†å“
DELETE /api/items/{itemId}             åˆ é™¤å•†å“
POST   /api/items/check-stock          æ£€æŸ¥åº“å­˜
```

### è´­ç‰©è½¦æ¨¡å—ï¼ˆ5ä¸ªï¼‰
```
GET    /api/cart                       è·å–è´­ç‰©è½¦
POST   /api/cart/add                   æ·»åŠ å•†å“
PUT    /api/cart/{itemId}              ä¿®æ”¹æ•°é‡
DELETE /api/cart/{itemId}              åˆ é™¤å•†å“
DELETE /api/cart                       æ¸…ç©ºè´­ç‰©è½¦
```

### è®¢å•æ¨¡å—ï¼ˆ8ä¸ªï¼‰
```
POST   /api/orders                     åˆ›å»ºè®¢å• â­
GET    /api/orders                     è®¢å•åˆ—è¡¨
GET    /api/orders/{orderId}           è®¢å•è¯¦æƒ…
PUT    /api/orders/{orderId}/status    æ›´æ–°çŠ¶æ€
DELETE /api/orders/{orderId}           å–æ¶ˆè®¢å•
GET    /api/addresses                  åœ°å€åˆ—è¡¨
POST   /api/addresses                  æ·»åŠ åœ°å€
PUT    /api/addresses/{addressId}      æ›´æ–°åœ°å€
```

---

## âš¡ å…³é”®å¤æ‚åº¦

### æœ€å¤æ‚ï¼šè®¢å•åˆ›å»ºï¼ˆéœ€äº‹åŠ¡å¤„ç†ï¼‰
```python
with db.engine.begin() as connection:
    # 1. é”å®šåº“å­˜è¡Œ
    connection.execute("SELECT stock FROM items WHERE id = ? FOR UPDATE")
    
    # 2. æ£€æŸ¥åº“å­˜å……è¶³
    if stock < quantity: raise Exception()
    
    # 3. æ‰£å‡åº“å­˜
    connection.execute("UPDATE items SET stock = stock - ?")
    
    # 4. åˆ›å»ºè®¢å•
    order = Order(...)
    
    # 5. è‡ªåŠ¨COMMITæˆ–ROLLBACK
```

### æ¬¡å¤æ‚ï¼šæœç´¢ä¸åˆ†ç±»
```python
# éå¤§å°å†™æ•æ„Ÿæœç´¢
SELECT * FROM items 
WHERE LOWER(title) LIKE LOWER(:query) 
  AND category = :category 
  AND price BETWEEN :min AND :max
ORDER BY created_at DESC
LIMIT :limit OFFSET :offset
```

### æ¬¡å¤æ‚ï¼šå¯†ç å®‰å…¨å­˜å‚¨
```python
from bcrypt import hashpw, checkpw
password_hash = hashpw(password.encode(), gensalt(rounds=12))
checkpw(password.encode(), stored_hash)
```

---

## ğŸ“¦ å·¥ç¨‹é‡ä¼°ç®—

| é˜¶æ®µ | ä»»åŠ¡ | å·¥ç¨‹é‡ | ä¼˜å…ˆçº§ |
|------|------|--------|--------|
| 1 | æ•°æ®åº“ + ORM | 1.5å¤© | P0 |
| 2 | ç”¨æˆ·è®¤è¯ | 2å¤© | P0 |
| 3 | å•†å“ç®¡ç† | 2.5å¤© | P0 |
| 4 | è´­ç‰©è½¦ | 1.5å¤© | P1 |
| 5 | **è®¢å•ä¸äº‹åŠ¡** | **3å¤©** | **P0** |
| 6 | æµ‹è¯•ä¸ä¼˜åŒ– | 2å¤© | P1 |
| **æ€»è®¡** | | **12.5å¤©** | |

---

## ğŸ› ï¸ å¼€å‘å·¥å…·é“¾

### å¿…éœ€ä¾èµ–
```
Flask==2.3.3
Flask-SQLAlchemy==3.0.5
Flask-JWT-Extended==4.5.3
bcrypt==4.1.1
PyMySQL==1.1.0
```

### å¼€å‘è¾…åŠ©
```bash
# æµ‹è¯•
pytest pytest-cov

# è°ƒè¯•
Flask debug toolbar

# æ€§èƒ½
Flask-Caching Redis

# æ–‡æ¡£
Flask-RESTX
```

---

## âœ… å®ç°æ£€æŸ¥æ¸…å•

### åŸºç¡€è®¾æ–½
- [ ] MySQL æ•°æ®åº“åˆ›å»º
- [ ] SQLAlchemy ORM æ¨¡å‹å®šä¹‰
- [ ] ç»Ÿä¸€å“åº”æ ¼å¼å‡½æ•°
- [ ] å…¨å±€é”™è¯¯å¤„ç†
- [ ] æ•°æ®æ ¡éªŒå·¥å…·

### ç”¨æˆ·è®¤è¯ï¼ˆP0ï¼‰
- [ ] ç”¨æˆ·æ³¨å†Œæ¥å£ï¼ˆé‚®ç®±æ ¡éªŒï¼‰
- [ ] ç”¨æˆ·ç™»å½•æ¥å£ï¼ˆJWT Tokenï¼‰
- [ ] å¯†ç å®‰å…¨å­˜å‚¨ï¼ˆbcryptï¼‰
- [ ] TokenéªŒè¯ä¸­é—´ä»¶
- [ ] ç”¨æˆ·ä¿¡æ¯è·å–

### å•†å“ç®¡ç†ï¼ˆP0ï¼‰
- [ ] å‘å¸ƒå•†å“æ¥å£
- [ ] å•†å“æœç´¢ï¼ˆéå¤§å°å†™æ•æ„Ÿï¼‰
- [ ] åˆ†ç±»æµè§ˆ
- [ ] å•†å“è¯¦æƒ…
- [ ] åº“å­˜ç®¡ç†
- [ ] æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–

### è´­ç‰©è½¦ï¼ˆP1ï¼‰
- [ ] Session ç®¡ç†
- [ ] è´­ç‰©è½¦CRUD
- [ ] åº“å­˜å®æ—¶éªŒè¯ï¼ˆä¸æŒä¹…åŒ–ï¼‰

### è®¢å•ä¸ç»“è´¦ï¼ˆP0ï¼‰â­
- [ ] è®¢å•åˆ›å»ºï¼ˆäº‹åŠ¡å¤„ç†ï¼‰
- [ ] åº“å­˜æ‰£å‡ï¼ˆè¡Œçº§é”ï¼‰
- [ ] è®¢å•æŸ¥è¯¢
- [ ] è®¢å•å–æ¶ˆï¼ˆåº“å­˜å›æ»šï¼‰
- [ ] é…é€åœ°å€ç®¡ç†
- [ ] å¹¶å‘æµ‹è¯•

### æµ‹è¯•ä¸ä¼˜åŒ–
- [ ] å•å…ƒæµ‹è¯•
- [ ] é›†æˆæµ‹è¯•
- [ ] å‹åŠ›æµ‹è¯•ï¼ˆå¹¶å‘ä¸‹å•ï¼‰
- [ ] SQLæŸ¥è¯¢ä¼˜åŒ–
- [ ] åŠ å¯†å’Œå®‰å…¨å®¡è®¡

---

## ğŸ”’ å®‰å…¨æ£€æŸ¥æ¸…å•

- [ ] å¯†ç ä½¿ç”¨bcryptåŠ å¯†ï¼Œæ°¸ä¸æ˜æ–‡å­˜å‚¨
- [ ] æ‰€æœ‰è¾“å…¥è¿›è¡ŒSQLæ³¨å…¥é˜²æŠ¤ï¼ˆä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼‰
- [ ] APIæ¥å£ä½¿ç”¨JWTè®¤è¯
- [ ] æƒé™æ£€æŸ¥ï¼ˆç”¨æˆ·åªèƒ½æ“ä½œè‡ªå·±çš„æ•°æ®ï¼‰
- [ ] æ•°æ®åº“äº‹åŠ¡ä¿è¯ACIDç‰¹æ€§
- [ ] æ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç ã€Tokenï¼‰ä¸åœ¨æ—¥å¿—ä¸­è¾“å‡º
- [ ] ä½¿ç”¨HTTPSï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- [ ] CORSé…ç½®æ­£ç¡®

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹ç¤ºä¾‹

### æ³¨å†Œ
```bash
POST /api/auth/register
{
  "username": "testuser",
  "email": "test@seu.edu.cn",
  "password": "TestPass123"
}
```

### ç™»å½•
```bash
POST /api/auth/login
{
  "username": "testuser",
  "password": "TestPass123"
}
# è¿”å›ï¼š{"token": "eyJ..."}
```

### æœç´¢å•†å“
```bash
GET /api/items/search?query=æ•™æ&category=books&page=1&limit=12
```

### åˆ›å»ºè®¢å•ï¼ˆå…³é”®æµ‹è¯•ï¼‰
```bash
POST /api/orders
{
  "items": [
    {"item_id": 1, "quantity": 2},
    {"item_id": 2, "quantity": 1}
  ],
  "address_id": 1
}
# éœ€éªŒè¯ï¼šåº“å­˜è¶³å¤Ÿ â†’ åˆ›å»ºæˆåŠŸ âœ…
# éœ€éªŒè¯ï¼šåº“å­˜ä¸è¶³ â†’ åˆ›å»ºå¤±è´¥ âœ…
# éœ€éªŒè¯ï¼šå¹¶å‘ä¸‹å•æ—¶åº“å­˜ä¸å†²çª âœ…
```

---

## ğŸš€ å¿«é€Ÿå¯åŠ¨æ­¥éª¤

### 1. åˆ›å»ºæ•°æ®åº“
```bash
mysql -u root -p seu_trading < database/schema.sql
mysql -u root -p seu_trading < database/seed_data.sql
```

### 2. å®‰è£…ä¾èµ–
```bash
pip install -r requirements.txt
```

### 3. åˆå§‹åŒ–åº”ç”¨
```bash
# åœ¨ run.py ä¸­åˆ›å»º Flask app
from app import create_app
app = create_app()
if __name__ == '__main__':
    app.run(debug=True)
```

### 4. å¯åŠ¨æœåŠ¡
```bash
python run.py
# è®¿é—® http://localhost:5000
```

### 5. æµ‹è¯•API
```bash
curl -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"zhangsan","password":"Password123"}'
```

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- å‰ç«¯è®¾è®¡: [å‰ç«¯è®¾è®¡.md](å‰ç«¯è®¾è®¡.md)
- å‰ç«¯API: [FRONTEND_API_DOCS.md](FRONTEND_API_DOCS.md)
- åç«¯åˆ†æ: [åç«¯å®ç°åˆ†æ.md](åç«¯å®ç°åˆ†æ.md)
- å¼€å‘æŒ‡å—: [åç«¯å¼€å‘æŒ‡å—.md](åç«¯å¼€å‘æŒ‡å—.md)

---

## ğŸ’¡ å¸¸è§é—®é¢˜

**Q: è´­ç‰©è½¦æ•°æ®å­˜åœ¨å“ªé‡Œï¼Ÿ**
A: Flask Sessionï¼ˆå†…å­˜ï¼‰ï¼Œæ–­å¼€è¿æ¥æˆ–æµè§ˆå™¨å…³é—­æ—¶æ¸…ç©ºã€‚ä¸å­˜å‚¨åœ¨æ•°æ®åº“ã€‚

**Q: å¦‚ä½•å¤„ç†å¹¶å‘ä¸‹å•çš„åº“å­˜å†²çªï¼Ÿ**
A: ä½¿ç”¨ `SELECT FOR UPDATE` è¡Œçº§é”ä¿è¯åŸå­æ€§ã€‚

**Q: å¦‚ä½•æ¢å¤å–æ¶ˆè®¢å•çš„åº“å­˜ï¼Ÿ**
A: åœ¨å–æ¶ˆè®¢å•æ—¶ï¼Œä½¿ç”¨äº‹åŠ¡å°†åº“å­˜åŠ å›ã€‚

**Q: æœç´¢åŠŸèƒ½å¦‚ä½•å®ç°éå¤§å°å†™æ•æ„Ÿï¼Ÿ**
A: ä½¿ç”¨ `LOWER()` å‡½æ•°æˆ–åœ¨åˆ›å»ºè¡¨æ—¶æŒ‡å®š `COLLATE utf8mb4_unicode_ci`ã€‚

**Q: å¦‚ä½•éªŒè¯ @seu.edu.cn é‚®ç®±ï¼Ÿ**
A: æ­£åˆ™è¡¨è¾¾å¼ `/^[a-zA-Z0-9._-]+@seu\.edu\.cn$/`

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2024-12-24  
**ç»´æŠ¤è€…**: åç«¯å¼€å‘å›¢é˜Ÿ
