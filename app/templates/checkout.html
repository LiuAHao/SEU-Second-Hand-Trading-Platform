{% extends "base.html" %}

{% block title %}ç»“è´¦ - ä¸œå—å¤§å­¦æ ¡å›­äºŒæ‰‹äº¤æ˜“å¹³å°{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <h1>è®¢å•ç»“è´¦</h1>
        <p style="color: rgba(255, 255, 255, 0.9); margin-bottom: 0;">å®Œæˆæ‚¨çš„é‡‡è´­ï¼Œäº«å—æ ¡å›­é…é€æœåŠ¡</p>
    </div>
</div>

<div class="container">
    <div class="grid grid--cols-3">
        <!-- ä¸»å†…å®¹ -->
        <div style="grid-column: 1 / 3;">
            <form id="checkout-form">
                <!-- æ­¥éª¤ 1: æ”¶è´§åœ°å€ -->
                <div class="card" style="margin-bottom: var(--spacing-lg);">
                    <div class="card__header" style="background: var(--color-primary-light);">
                        <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                            <span style="display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: var(--color-primary); color: white; border-radius: 50%; font-weight: bold;">1</span>
                            <h3 style="margin: 0;">æ”¶è´§åœ°å€</h3>
                        </div>
                    </div>
                    <div class="card__body">
                        <!-- åœ°å€åˆ—è¡¨ -->
                        <div id="addresses-list" style="margin-bottom: var(--spacing-lg);">
                            <div class="skeleton" style="height: 80px; margin-bottom: var(--spacing-md);"></div>
                            <div class="skeleton" style="height: 80px;"></div>
                        </div>

                        <!-- æ–°å¢åœ°å€è¡¨å• -->
                        <div id="new-address-form" style="display: none; padding-top: var(--spacing-lg); border-top: 1px solid var(--color-border);">
                            <h4 style="margin-bottom: var(--spacing-md);">æ·»åŠ æ–°åœ°å€</h4>
                            <div class="grid grid--cols-2">
                                <div class="form-group">
                                    <label class="form-label">æ”¶è´§äºº</label>
                                    <input type="text" name="recipient_name" class="form-input" placeholder="è¯·å¡«å†™æ”¶è´§äºº" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">æ‰‹æœºå·</label>
                                    <input type="text" name="phone" class="form-input" placeholder="è¯·å¡«å†™æ‰‹æœºå·" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">åŸå¸‚</label>
                                    <input type="text" name="city" class="form-input" placeholder="å¦‚ï¼šå—äº¬" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">åŒº/å®¿èˆæ¥¼</label>
                                    <input type="text" name="district" class="form-input" placeholder="å¦‚ï¼šä¹é¾™æ¹–å®¿èˆ A æ ‹" required>
                                </div>
                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <label class="form-label">è¯¦ç»†åœ°å€</label>
                                    <input type="text" name="detail" class="form-input" placeholder="æ¥¼å±‚ã€æˆ¿é—´å·ç­‰" required>
                                </div>
                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <label class="form-checkbox" style="display: inline-flex; align-items: center; gap: 8px;">
                                        <input type="checkbox" name="is_default">
                                        è®¾ä¸ºé»˜è®¤åœ°å€
                                    </label>
                                </div>
                            </div>
                            <button type="button" id="cancel-new-address" class="btn btn--secondary">å–æ¶ˆ</button>
                            <button type="button" id="confirm-new-address" class="btn btn--primary">ç¡®å®š</button>
                        </div>

                        <button type="button" id="add-new-address" class="btn btn--text">+ æ·»åŠ æ–°åœ°å€</button>
                    </div>
                </div>

                <!-- æ­¥éª¤ 2: æ”¯ä»˜æ–¹å¼ -->
                <div class="card" style="margin-bottom: var(--spacing-lg);">
                    <div class="card__header" style="background: var(--color-primary-light);">
                        <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                            <span style="display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: var(--color-primary); color: white; border-radius: 50%; font-weight: bold;">2</span>
                            <h3 style="margin: 0;">æ”¯ä»˜æ–¹å¼</h3>
                        </div>
                    </div>
                    <div class="card__body">
                        <div style="display: grid; gap: var(--spacing-md);">
                            <label style="display: flex; align-items: center; gap: var(--spacing-md); padding: var(--spacing-md); border: 2px solid var(--color-border); border-radius: var(--radius-lg); cursor: pointer;">
                                <input type="radio" name="payment_method" value="wechat" checked>
                                <span>ğŸ’š å¾®ä¿¡æ”¯ä»˜</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: var(--spacing-md); padding: var(--spacing-md); border: 2px solid var(--color-border); border-radius: var(--radius-lg); cursor: pointer;">
                                <input type="radio" name="payment_method" value="alipay">
                                <span>ğŸ”µ æ”¯ä»˜å®</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: var(--spacing-md); padding: var(--spacing-md); border: 2px solid var(--color-border); border-radius: var(--radius-lg); cursor: pointer;">
                                <input type="radio" name="payment_method" value="card">
                                <span>ğŸ’³ å‚¨å€¼å¡</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- æ­¥éª¤ 3: è®¢å•ç¡®è®¤ -->
                <div class="card">
                    <div class="card__header" style="background: var(--color-primary-light);">
                        <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                            <span style="display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: var(--color-primary); color: white; border-radius: 50%; font-weight: bold;">3</span>
                            <h3 style="margin: 0;">è®¢å•ç¡®è®¤</h3>
                        </div>
                    </div>
                    <div class="card__body">
                        <!-- è®¢å•å•†å“åˆ—è¡¨ -->
                        <div style="margin-bottom: var(--spacing-lg);">
                            <h4 style="margin-bottom: var(--spacing-md);">è®¢å•å•†å“</h4>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>å•†å“</th>
                                        <th>å•ä»·</th>
                                        <th>æ•°é‡</th>
                                        <th>å°è®¡</th>
                                    </tr>
                                </thead>
                                <tbody id="order-items">
                                    <!-- åŠ¨æ€å¡«å…… -->
                                </tbody>
                            </table>
                        </div>

                        <!-- å¤‡æ³¨ -->
                        <div class="form-group">
                            <label class="form-label">è®¢å•å¤‡æ³¨</label>
                            <textarea 
                                name="notes" 
                                class="form-textarea" 
                                placeholder="å¦‚æœ‰ç‰¹æ®Šè¦æ±‚ï¼Œè¯·åœ¨è¿™é‡Œè¯´æ˜"
                                style="min-height: 80px;"
                            ></textarea>
                        </div>

                        <!-- å‹¾é€‰åè®® -->
                        <label style="display: flex; align-items: flex-start; gap: var(--spacing-sm); margin-bottom: var(--spacing-lg);">
                            <input type="checkbox" name="agree_terms" required>
                            <span>æˆ‘å·²é˜…è¯»å¹¶åŒæ„<a href="#">ã€Šäº¤æ˜“è§„åˆ™ã€‹</a>å’Œ<a href="#">ã€Šéšç§ä¿æŠ¤ã€‹</a>ï¼Œç¡®è®¤ä¸Šè¿°åœ°å€ä¿¡æ¯æ— è¯¯</span>
                        </label>

                        <!-- æäº¤æŒ‰é’® -->
                        <button type="submit" class="btn btn--primary btn--lg btn--block">
                            æäº¤è®¢å•å¹¶æ”¯ä»˜
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- å³ä¾§: è®¢å•æ‘˜è¦ -->
        <div style="grid-column: 3 / 4;">
            <div class="card" style="position: sticky; top: 80px;">
                <div class="card__header">
                    <h3 style="margin: 0;">è®¢å•æ‘˜è¦</h3>
                </div>
                <div class="card__body">
                    <!-- å•†å“æ•°é‡ -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-md);">
                        <span>å•†å“æ•°é‡:</span>
                        <span class="font-bold" id="summary-count">0</span>
                    </div>

                    <!-- å°è®¡ -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-md);">
                        <span>å•†å“å°è®¡:</span>
                        <span class="font-bold">Â¥<span id="summary-subtotal">0.00</span></span>
                    </div>

                    <!-- è¿è´¹ -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-md); color: var(--color-success);">
                        <span>è¿è´¹:</span>
                        <span class="font-bold">å…è´¹</span>
                    </div>

                    <!-- åˆ†å‰²çº¿ -->
                    <div style="border-top: 2px solid var(--color-border); margin: var(--spacing-md) 0;"></div>

                    <!-- æ€»è®¡ -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-lg);">
                        <span class="font-semibold">åº”ä»˜æ€»é¢:</span>
                        <span style="font-size: var(--font-size-2xl); color: var(--color-primary); font-weight: bold;">
                            Â¥<span id="summary-total">0.00</span>
                        </span>
                    </div>

                    <!-- ä¿¡æ¯æç¤º -->
                    <div class="alert alert--info">
                        <span>â„¹ï¸</span>
                        <div>
                            <strong>é…é€ä¿¡æ¯</strong>
                            <p style="margin: var(--spacing-xs) 0 0 0; font-size: var(--font-size-sm);">
                                å•†å“å°†åœ¨æ”¯ä»˜æˆåŠŸå 1-3 ä¸ªå·¥ä½œæ—¥é€è‡³æ‚¨æŒ‡å®šçš„æ ¡å›­åœ°ç‚¹ã€‚
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
/**
 * ç»“è´¦é¡µé¢é€»è¾‘
 */
class CheckoutPage {
    constructor() {
        this.cart = CartManager.getCart();
        this.addresses = [];
        this.selectedAddressId = null;
        this.init();
    }

    async init() {
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!AuthManager.isLoggedIn()) {
            window.location.href = `/login?redirect=/checkout`;
            return;
        }

        // æ£€æŸ¥è´­ç‰©è½¦æ˜¯å¦ä¸ºç©º
        if (this.cart.length === 0) {
            NotificationManager.warning('è´­ç‰©è½¦ä¸ºç©ºï¼Œè¯·å…ˆæ·»åŠ å•†å“');
            setTimeout(() => {
                window.location.href = '/';
            }, 1500);
            return;
        }

        await this.loadAddresses();
        this.renderOrderItems();
        this.updateOrderSummary();
        this.setupEventListeners();
    }

    async loadAddresses() {
        try {
            const response = await API.address.getList();
            this.addresses = Array.isArray(response.data) ? response.data : (response.data?.items || []);
            this.renderAddresses();
        } catch (error) {
            console.error('åŠ è½½åœ°å€å¤±è´¥:', error);
            NotificationManager.error('åŠ è½½é…é€åœ°å€å¤±è´¥');
        }
    }

    renderAddresses() {
        const container = document.getElementById('addresses-list');
        
        if (this.addresses.length === 0) {
            container.innerHTML = `
                <div class="alert alert--warning">
                    æš‚æ— åœ°å€ï¼Œè¯·æ·»åŠ æ”¶è´§åœ°å€
                </div>
            `;
            return;
        }

        container.innerHTML = this.addresses.map((addr) => `
            <label style="display: block; padding: var(--spacing-md); border: 2px solid ${addr.is_default ? 'var(--color-primary)' : 'var(--color-border)'}; border-radius: var(--radius-lg); margin-bottom: var(--spacing-sm); cursor: pointer;">
                <input type="radio" name="address" value="${addr.id}" ${addr.is_default ? 'checked' : ''} required>
                <div style="display:flex; justify-content: space-between; align-items:center;">
                    <div><strong>${addr.recipient_name}</strong> ${addr.phone}</div>
                    ${addr.is_default ? '<span class="badge badge--primary">é»˜è®¤</span>' : ''}
                </div>
                <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-top: var(--spacing-xs);">
                    ${addr.full_address || addr.detail}
                </div>
            </label>
        `).join('');

        const defaultAddr = this.addresses.find(a => a.is_default) || this.addresses[0];
        this.selectedAddressId = defaultAddr?.id || null;

        container.querySelectorAll('input[name="address"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                this.selectedAddressId = e.target.value;
            });
        });
    }

    renderOrderItems() {
        const tbody = document.getElementById('order-items');
        
        tbody.innerHTML = this.cart.map(item => `
            <tr>
                <td>${item.title}</td>
                <td>Â¥${item.price.toFixed(2)}</td>
                <td>${item.quantity}</td>
                <td>Â¥${(item.price * item.quantity).toFixed(2)}</td>
            </tr>
        `).join('');
    }

    updateOrderSummary() {
        const stats = CartManager.getStats();
        document.getElementById('summary-count').textContent = stats.count;
        document.getElementById('summary-subtotal').textContent = stats.total;
        document.getElementById('summary-total').textContent = stats.total;
    }

    async addNewAddress() {
        const form = document.getElementById('new-address-form');
        const getVal = (name) => form.querySelector(`[name="${name}"]`).value.trim();
        const recipient_name = getVal('recipient_name');
        const phone = getVal('phone');
        const city = getVal('city');
        const district = getVal('district');
        const detail = getVal('detail');
        const is_default = form.querySelector('[name="is_default"]').checked;

        if (!recipient_name || !phone || !city || !district || !detail) {
            NotificationManager.error('è¯·å®Œæ•´å¡«å†™æ”¶è´§åœ°å€ä¿¡æ¯');
            return;
        }

        LoadingManager.show('æ­£åœ¨ä¿å­˜åœ°å€...');
        try {
            const resp = await API.address.add({
                recipient_name,
                phone,
                city,
                district,
                detail,
                is_default,
            });

            if (resp.data) {
                const saved = {
                    ...resp.data,
                    full_address: `${resp.data.city || ''}${resp.data.district || ''}${resp.data.detail || ''}`
                };
                this.addresses = [saved, ...this.addresses];
                if (saved.is_default) {
                    this.addresses = this.addresses.map(addr => ({
                        ...addr,
                        is_default: addr.id === saved.id
                    }));
                }
                this.renderAddresses();
                form.querySelectorAll('input').forEach(input => {
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                });
                form.style.display = 'none';
                NotificationManager.success('åœ°å€å·²æ·»åŠ ');
            }
        } catch (error) {
            if (error?.data?.message) {
                NotificationManager.error(error.data.message);
            } else {
                NotificationManager.error('ä¿å­˜åœ°å€å¤±è´¥');
            }
        } finally {
            LoadingManager.hide();
        }
    }

    setupEventListeners() {
        // æ·»åŠ æ–°åœ°å€
        document.getElementById('add-new-address').addEventListener('click', () => {
            document.getElementById('new-address-form').style.display = 'block';
        });

        document.getElementById('cancel-new-address').addEventListener('click', () => {
            document.getElementById('new-address-form').style.display = 'none';
        });

        document.getElementById('confirm-new-address').addEventListener('click', () => {
            this.addNewAddress();
        });

        // è¡¨å•æäº¤
        document.getElementById('checkout-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const addressId = parseInt(this.selectedAddressId, 10);
            if (!addressId) {
                NotificationManager.error('è¯·é€‰æ‹©é…é€åœ°å€');
                return;
            }

            const formData = new FormData(e.target);
            
            LoadingManager.show('æ­£åœ¨æäº¤è®¢å•...');

            try {
                const orderData = {
                    items: this.cart.map(item => ({
                        item_id: item.itemId,
                        quantity: item.quantity,
                    })),
                    address_id: addressId,
                    payment_method: formData.get('payment_method'),
                    notes: formData.get('notes'),
                };

                const response = await API.order.create(orderData);
                LoadingManager.hide();

                if (response.data?.orderId) {
                    NotificationManager.success('è®¢å•æäº¤æˆåŠŸï¼');
                    
                    // æ¸…ç©ºè´­ç‰©è½¦
                    CartManager.clear();

                    // è·³è½¬åˆ°æ”¯ä»˜é¡µé¢æˆ–è®¢å•è¯¦æƒ…é¡µ
                    setTimeout(() => {
                        window.location.href = `/orders/${response.data.orderId}`;
                    }, 1000);
                }
            } catch (error) {
                LoadingManager.hide();
                
                if (error.data?.message) {
                    NotificationManager.error(error.data.message);
                } else {
                    NotificationManager.error('è®¢å•æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            }
        });
    }
}

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    new CheckoutPage();
});
</script>
{% endblock %}
