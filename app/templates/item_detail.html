{% extends "base.html" %}

{% block title %}å•†å“è¯¦æƒ… - ä¸œå—å¤§å­¦æ ¡å›­äºŒæ‰‹äº¤æ˜“å¹³å°{% endblock %}

{% block content %}
<div class="container" style="margin-top: var(--spacing-2xl); margin-bottom: var(--spacing-2xl);">
    <!-- åŠ è½½éª¨æ¶å± -->
    <div id="loading-skeleton" class="grid grid--cols-2">
        <div class="skeleton" style="height: 400px;"></div>
        <div>
            <div class="skeleton" style="height: 40px; margin-bottom: var(--spacing-md);"></div>
            <div class="skeleton" style="height: 100px; margin-bottom: var(--spacing-md);"></div>
            <div class="skeleton" style="height: 30px; margin-bottom: var(--spacing-md);"></div>
            <div class="skeleton" style="height: 30px;"></div>
        </div>
    </div>

    <!-- è¯¦æƒ…å†…å®¹ -->
    <div id="detail-content" style="display: none; grid-template-columns: 1fr 1fr; gap: var(--spacing-2xl); grid-template-rows: auto;" class="grid">
        <!-- å·¦ä¾§ï¼šå›¾ç‰‡ -->
        <div>
            <div style="background: var(--color-bg-tertiary); border-radius: var(--radius-lg); overflow: hidden; margin-bottom: var(--spacing-lg);">
                <img id="main-image" src="" alt="å•†å“å›¾ç‰‡" style="width: 100%; height: 400px; object-fit: cover;">
                <div id="main-image-empty" class="product-card__image--empty detail-image-empty" style="display: none;">æš‚æ— å•†å“å›¾ç‰‡</div>
            </div>
            <!-- ç¼©ç•¥å›¾åˆ—è¡¨ -->
            <div id="thumbnails" class="grid grid--cols-4" style="gap: var(--spacing-sm);">
            </div>
        </div>

        <!-- å³ä¾§ï¼šä¿¡æ¯ -->
        <div>
            <!-- åˆ†ç±» -->
            <span id="category-badge" class="badge badge--primary" style="margin-bottom: var(--spacing-md);"></span>

            <!-- æ ‡é¢˜ -->
            <h1 id="item-title" style="margin-bottom: var(--spacing-md);"></h1>

            <!-- æè¿° -->
            <p id="item-description" style="margin-bottom: var(--spacing-lg); color: var(--color-text-secondary); line-height: var(--line-height-relaxed);"></p>

            <!-- ä»·æ ¼å’Œåº“å­˜ -->
            <div class="card" style="margin-bottom: var(--spacing-lg); padding: var(--spacing-lg);">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg); margin-bottom: var(--spacing-lg);">
                    <div>
                        <div class="text-muted" style="font-size: var(--font-size-sm); margin-bottom: var(--spacing-sm);">å”®ä»·</div>
                        <div class="text-2xl font-bold" style="color: var(--color-primary); font-size: var(--font-size-2xl);">
                            Â¥<span id="item-price">0.00</span>
                        </div>
                    </div>
                    <div>
                        <div class="text-muted" style="font-size: var(--font-size-sm); margin-bottom: var(--spacing-sm);">åº“å­˜</div>
                        <div class="font-bold" style="font-size: var(--font-size-lg);">
                            <span id="item-stock">0</span> ä»¶
                        </div>
                    </div>
                </div>

                <!-- æ•°é‡é€‰æ‹© -->
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">è´­ä¹°æ•°é‡</label>
                    <div style="display: flex; gap: var(--spacing-sm); align-items: center;">
                        <button id="decrease-qty" class="btn btn--secondary" style="width: 40px;">âˆ’</button>
                        <input id="quantity" type="number" class="form-input" value="1" min="1" max="99" style="flex: 0 1 140px; min-width: 120px; text-align: center;">
                        <button id="increase-qty" class="btn btn--secondary" style="width: 40px;">+</button>
                    </div>
                </div>
            </div>

            <!-- å–å®¶ä¿¡æ¯ -->
            <div class="card" style="margin-bottom: var(--spacing-lg); padding: var(--spacing-lg);">
                <h3 style="margin-top: 0;">å–å®¶ä¿¡æ¯</h3>
                <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                    <div style="width: 48px; height: 48px; border-radius: 50%; background: var(--color-bg-tertiary); display: flex; align-items: center; justify-content: center; font-size: 24px;">
                        ğŸ‘¤
                    </div>
                    <div>
                        <div class="font-bold" id="seller-name"></div>
                        <div class="text-sm text-muted" id="seller-info"></div>
                    </div>
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                <button id="add-to-cart-btn" class="btn btn--primary btn--lg">
                    ğŸ›’ åŠ å…¥è´­ç‰©è½¦
                </button>
                <button id="buy-now-btn" class="btn btn--secondary btn--lg">
                    ç«‹å³è´­ä¹°
                </button>
            </div>

            <!-- æç¤º -->
            <div id="stock-warning" class="alert alert--warning" style="margin-top: var(--spacing-lg); display: none;">
                âš ï¸ åº“å­˜ä¸è¶³ï¼Œæ— æ³•è´­ä¹°
            </div>
        </div>

        <!-- å•†å“è¯¦æƒ… -->
        <div style="grid-column: 1 / -1; margin-top: var(--spacing-2xl);">
            <div class="card">
                <div class="card__body">
                    <h3>å•†å“è¯¦æƒ…</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: var(--spacing-md);">
                        <div class="card" style="padding: var(--spacing-md); background: var(--color-bg-soft);">
                            <div class="text-muted" style="font-size: var(--font-size-sm);">åˆ†ç±»</div>
                            <div class="font-semibold" id="detail-category">-</div>
                        </div>
                        <div class="card" style="padding: var(--spacing-md); background: var(--color-bg-soft);">
                            <div class="text-muted" style="font-size: var(--font-size-sm);">å‘å¸ƒæ—¶é—´</div>
                            <div class="font-semibold" id="detail-published">-</div>
                        </div>
                        <div class="card" style="padding: var(--spacing-md); background: var(--color-bg-soft);">
                            <div class="text-muted" style="font-size: var(--font-size-sm);">æµè§ˆæ¬¡æ•°</div>
                            <div class="font-semibold" id="detail-views">-</div>
                        </div>
                    </div>
                    <div class="card" style="margin-top: var(--spacing-md); padding: var(--spacing-md); background: var(--color-bg-soft);">
                        <div class="text-muted" style="font-size: var(--font-size-sm); margin-bottom: var(--spacing-xs);">å•†å“æè¿°</div>
                        <div id="detail-description" style="white-space: pre-line; line-height: var(--line-height-relaxed);">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
/**
 * å•†å“è¯¦æƒ…é¡µé€»è¾‘
 */
class ItemDetailPage {
    constructor() {
        const itemId = window.location.pathname.split('/').pop();
        this.itemId = itemId;
        this.item = null;
        this.init();
    }

    async init() {
        await this.loadItemDetail();
        this.setupEventListeners();
    }

    async loadItemDetail() {
        try {
            const response = await API.item.getDetail(this.itemId);
            this.item = response.data;
            this.renderDetail();
        } catch (error) {
            LoadingManager.hide();
            NotificationManager.error('åŠ è½½å•†å“ä¿¡æ¯å¤±è´¥');
            console.error('åŠ è½½å•†å“å¤±è´¥:', error);
            setTimeout(() => {
                window.history.back();
            }, 2000);
        }
    }

    renderDetail() {
        const item = this.item;

        // éšè—éª¨æ¶å±ï¼Œæ˜¾ç¤ºå†…å®¹
        document.getElementById('loading-skeleton').style.display = 'none';
        document.getElementById('detail-content').style.display = 'grid';

        // å›¾ç‰‡
        const mainImage = document.getElementById('main-image');
        const mainImageEmpty = document.getElementById('main-image-empty');
        if (item.image) {
            mainImage.src = item.image;
            mainImage.style.display = 'block';
            mainImageEmpty.style.display = 'none';
        } else {
            mainImage.src = '';
            mainImage.style.display = 'none';
            mainImageEmpty.style.display = 'flex';
        }

        // åŸºæœ¬ä¿¡æ¯
        document.getElementById('item-title').textContent = item.title;
        document.getElementById('item-description').textContent = item.description;
        document.getElementById('item-price').textContent = item.price.toFixed(2);
        document.getElementById('item-stock').textContent = item.stock;
        document.getElementById('category-badge').textContent = item.category || 'æœªåˆ†ç±»';

        // å–å®¶ä¿¡æ¯
        document.getElementById('seller-name').textContent = item.seller_name || 'æœªçŸ¥å–å®¶';
        document.getElementById('seller-info').textContent = `è¯„åˆ†: ${(item.seller_rating || 0).toFixed(1)} â­`;

        // è¯¦æƒ…ä¿¡æ¯
        document.getElementById('detail-category').textContent = item.category || '-';
        document.getElementById('detail-published').textContent = new Date(item.created_at).toLocaleDateString('zh-CN');
        document.getElementById('detail-views').textContent = item.views || 0;
        document.getElementById('detail-description').textContent = item.description;

        // åº“å­˜çŠ¶æ€
        if (item.stock <= 0) {
            document.getElementById('stock-warning').style.display = 'block';
            document.getElementById('quantity').disabled = true;
            document.getElementById('add-to-cart-btn').disabled = true;
            document.getElementById('buy-now-btn').disabled = true;
        }

        // æ›´æ–°æ•°é‡é™åˆ¶
        const quantityInput = document.getElementById('quantity');
        quantityInput.max = item.stock;
    }

    setupEventListeners() {
        // æ•°é‡è°ƒæ•´
        document.getElementById('decrease-qty').addEventListener('click', () => {
            const input = document.getElementById('quantity');
            const value = parseInt(input.value) || 1;
            if (value > 1) {
                input.value = value - 1;
            }
        });

        document.getElementById('increase-qty').addEventListener('click', () => {
            const input = document.getElementById('quantity');
            const value = parseInt(input.value) || 1;
            if (value < this.item.stock) {
                input.value = value + 1;
            }
        });

        // åŠ å…¥è´­ç‰©è½¦
        document.getElementById('add-to-cart-btn').addEventListener('click', () => {
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            CartManager.addItem({
                itemId: this.itemId,
                title: this.item.title,
                price: this.item.price,
                quantity,
            });
        });

        // ç«‹å³è´­ä¹°
        document.getElementById('buy-now-btn').addEventListener('click', () => {
            if (!AuthManager.isLoggedIn()) {
                NotificationManager.warning('è¯·å…ˆç™»å½•');
                window.location.href = `/login?redirect=/checkout`;
                return;
            }
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            CartManager.addItem({
                itemId: this.itemId,
                title: this.item.title,
                price: this.item.price,
                quantity,
                replaceQuantity: true,
            });
            setTimeout(() => {
                window.location.href = '/checkout';
            }, 500);
        });

    }
}

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    new ItemDetailPage();
});
</script>
{% endblock %}