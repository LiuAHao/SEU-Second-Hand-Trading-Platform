{% extends "base.html" %}

{% block title %}ä¸ªäººèµ„æ–™ - ä¸œå—å¤§å­¦æ ¡å›­äºŒæ‰‹äº¤æ˜“å¹³å°{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <h1>ä¸ªäººä¸­å¿ƒ</h1>
        <p style="color: rgba(255, 255, 255, 0.9); margin-bottom: 0;">ç®¡ç†æ‚¨çš„è´¦æˆ·å’Œè®¢å•ä¿¡æ¯</p>
    </div>
</div>

<!-- æœªç™»å½•æç¤º -->
<div id="login-required" class="container" style="display: none;">
    <div class="card">
        <div class="card__body" style="text-align: center; padding: var(--spacing-2xl);">
            <div style="font-size: 64px; margin-bottom: var(--spacing-lg);">ğŸ”’</div>
            <h2>è¯·å…ˆç™»å½•</h2>
            <p style="color: var(--color-text-secondary); margin-bottom: var(--spacing-xl);">æ‚¨éœ€è¦ç™»å½•åæ‰èƒ½æŸ¥çœ‹ä¸ªäººèµ„æ–™</p>
            <a href="/login?redirect=/profile" class="btn btn--primary btn--lg">ç«‹å³ç™»å½•</a>
        </div>
    </div>
</div>

<!-- å·²ç™»å½•å†…å®¹ -->
<div id="profile-content" class="container" style="display: none;">
    <div class="grid grid--cols-4">
        <!-- å·¦ä¾§èœå• -->
        <div style="grid-column: 1 / 2;">
            <div class="card" style="position: sticky; top: 80px;">
                <div class="card__body" style="padding: 0;">
                    <a href="#profile" class="tab-link is-active" style="display: block; padding: var(--spacing-md) var(--spacing-lg); border-bottom: 1px solid var(--color-border); cursor: pointer;">ğŸ‘¤ åŸºæœ¬ä¿¡æ¯</a>
                    <a href="#orders" class="tab-link" style="display: block; padding: var(--spacing-md) var(--spacing-lg); border-bottom: 1px solid var(--color-border); cursor: pointer;">ğŸ“¦ æˆ‘çš„è®¢å•</a>
                    <a href="#published" class="tab-link" style="display: block; padding: var(--spacing-md) var(--spacing-lg); border-bottom: 1px solid var(--color-border); cursor: pointer;">ğŸ“„ æˆ‘çš„å‘å¸ƒ</a>
                    <a href="#addresses" class="tab-link" style="display: block; padding: var(--spacing-md) var(--spacing-lg); border-bottom: 1px solid var(--color-border); cursor: pointer;">ğŸ“® æ”¶è´§åœ°å€</a>
                    <a href="#settings" class="tab-link" style="display: block; padding: var(--spacing-md) var(--spacing-lg); cursor: pointer;">âš™ï¸ è´¦æˆ·è®¾ç½®</a>
                </div>
            </div>
        </div>

        <!-- å³ä¾§å†…å®¹ -->
        <div style="grid-column: 2 / -1;">
            <!-- åŸºæœ¬ä¿¡æ¯æ ‡ç­¾ -->
            <div id="profile-tab" class="tab-content is-active">
                <div class="card" style="margin-bottom: var(--spacing-lg);">
                    <div class="card__header">
                        <h2 style="margin: 0;">åŸºæœ¬ä¿¡æ¯</h2>
                    </div>
                    <div class="card__body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-2xl); margin-bottom: var(--spacing-2xl);">
                            <!-- å¤´åƒ -->
                            <div style="text-align: center;">
                                <div style="width: 120px; height: 120px; border-radius: 50%; background: var(--color-bg-tertiary); display: flex; align-items: center; justify-content: center; overflow: hidden; margin: 0 auto var(--spacing-md);">
                                    <img id="profile-avatar" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'><rect width='120' height='120' rx='60' fill='%23e9edf3'/><circle cx='60' cy='48' r='22' fill='%23c9d2df'/><rect x='26' y='78' width='68' height='28' rx='14' fill='%23c9d2df'/></svg>" alt="å¤´åƒ" style="width:100%; height:100%; object-fit: cover;">
                                </div>
                                <input type="file" id="avatar-file-input" accept="image/*" style="display:none;">
                                <button id="change-avatar-btn" class="btn btn--secondary btn--sm">æ›´æ¢å¤´åƒ</button>
                            </div>

                            <!-- ä¿¡æ¯ -->
                            <div>
                                <div style="margin-bottom: var(--spacing-lg);">
                                    <div class="text-muted" style="font-size: var(--font-size-sm); margin-bottom: var(--spacing-sm);">ç”¨æˆ·å</div>
                                    <div class="font-semibold" id="profile-username"></div>
                                </div>
                                <div style="margin-bottom: var(--spacing-lg);">
                                    <div class="text-muted" style="font-size: var(--font-size-sm); margin-bottom: var(--spacing-sm);">é‚®ç®±</div>
                                    <div class="font-semibold" id="profile-email"></div>
                                </div>
                                <div style="margin-bottom: var(--spacing-lg);">
                                    <div class="text-muted" style="font-size: var(--font-size-sm); margin-bottom: var(--spacing-sm);">æ‰‹æœºå·</div>
                                    <div class="font-semibold" id="profile-phone">æœªå¡«å†™</div>
                                </div>
                                <div style="margin-bottom: var(--spacing-lg);">
                                    <div class="text-muted" style="font-size: var(--font-size-sm); margin-bottom: var(--spacing-sm);">æ³¨å†Œæ—¶é—´</div>
                                    <div class="font-semibold" id="profile-created-at"></div>
                                </div>
                                <div style="margin-bottom: var(--spacing-lg);">
                                    <div class="text-muted" style="font-size: var(--font-size-sm); margin-bottom: var(--spacing-sm);">ä¿¡ç”¨è¯„åˆ†</div>
                                    <div class="font-semibold">
                                        <span id="profile-rating">5.0</span> â­
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ç¼–è¾‘æŒ‰é’® -->
                        <button id="edit-profile-btn" class="btn btn--primary">ç¼–è¾‘åŸºæœ¬ä¿¡æ¯</button>
                    </div>
                </div>

                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="grid grid--cols-2">
                    <div class="card" style="text-align: center; padding: var(--spacing-lg);">
                        <div style="font-size: 32px; margin-bottom: var(--spacing-md);">ğŸ“¦</div>
                        <div class="text-muted" style="font-size: var(--font-size-sm); margin-bottom: var(--spacing-sm);">å·²å‘å¸ƒ</div>
                        <div class="font-bold" style="font-size: var(--font-size-2xl); color: var(--color-primary);" id="stats-published">0</div>
                    </div>
                    <div class="card" style="text-align: center; padding: var(--spacing-lg);">
                        <div style="font-size: 32px; margin-bottom: var(--spacing-md);">âœ…</div>
                        <div class="text-muted" style="font-size: var(--font-size-sm); margin-bottom: var(--spacing-sm);">å·²å”®å‡º</div>
                        <div class="font-bold" style="font-size: var(--font-size-2xl); color: var(--color-success);" id="stats-sold">0</div>
                    </div>
                </div>
            </div>

            <!-- æˆ‘çš„è®¢å•æ ‡ç­¾ -->
            <div id="orders-tab" class="tab-content" style="display: none;">
                <div class="card">
                    <div class="card__header">
                        <h2 style="margin: 0;">æˆ‘çš„è®¢å•</h2>
                    </div>
                    <div class="card__body">
                        <div id="orders-list" style="display: none;">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>è®¢å•å·</th>
                                        <th>å•†å“</th>
                                        <th>é‡‘é¢</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="orders-tbody">
                                    <!-- åŠ¨æ€å¡«å…… -->
                                </tbody>
                            </table>
                        </div>
                        <div id="orders-empty" class="empty-state">
                            <div class="empty-state__icon">ğŸ“­</div>
                            <div class="empty-state__title">æš‚æ— è®¢å•</div>
                            <p class="empty-state__description">æ‚¨è¿˜æ²¡æœ‰è´­ä¹°è¿‡ä»»ä½•å•†å“</p>
                            <a href="/" class="btn btn--primary">å¼€å§‹è´­ç‰©</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æˆ‘çš„å‘å¸ƒæ ‡ç­¾ -->
            <div id="published-tab" class="tab-content" style="display: none;">
                <div class="card" style="margin-bottom: var(--spacing-lg);">
                    <div class="card__header">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h2 style="margin: 0;">æˆ‘çš„å‘å¸ƒ</h2>
                            <a href="/publish-item" class="btn btn--primary btn--sm">+ å‘å¸ƒæ–°å•†å“</a>
                        </div>
                    </div>
                    <div class="card__body">
                        <div id="published-list" style="display: none;">
                            <div class="grid grid--cols-3" id="published-items">
                                <!-- åŠ¨æ€å¡«å…… -->
                            </div>
                        </div>
                        <div id="published-empty" class="empty-state">
                            <div class="empty-state__icon">ğŸ“„</div>
                            <div class="empty-state__title">æš‚æ— å‘å¸ƒ</div>
                            <p class="empty-state__description">æ‚¨è¿˜æ²¡æœ‰å‘å¸ƒè¿‡ä»»ä½•å•†å“</p>
                            <a href="/publish-item" class="btn btn--primary">ç«‹å³å‘å¸ƒ</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ”¶è´§åœ°å€æ ‡ç­¾ -->
            <div id="addresses-tab" class="tab-content" style="display: none;">
                <div class="card">
                    <div class="card__header" style="display:flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0;">æ”¶è´§åœ°å€</h2>
                        <button id="add-address-btn" class="btn btn--primary btn--sm">+ æ·»åŠ åœ°å€</button>
                    </div>
                    <div class="card__body">
                        <div id="addresses-list" class="grid grid--cols-2" style="gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                            <div class="skeleton" style="height: 120px;"></div>
                            <div class="skeleton" style="height: 120px;"></div>
                        </div>
                        <div id="addresses-empty" class="empty-state" style="display:none;">
                            <div class="empty-state__icon">ğŸ“®</div>
                            <div class="empty-state__title">æš‚æ— æ”¶è´§åœ°å€</div>
                            <p class="empty-state__description">æ·»åŠ ä¸€ä¸ªæ”¶è´§åœ°å€ä»¥ä¾¿å¿«é€Ÿä¸‹å•</p>
                        </div>

                        <div id="address-form" class="card" style="display:none; margin-top: var(--spacing-lg);">
                            <div class="card__header">
                                <h3 style="margin:0;">æ–°å¢åœ°å€</h3>
                            </div>
                            <div class="card__body">
                                <div class="grid grid--cols-2">
                                    <div class="form-group">
                                        <label class="form-label">æ”¶è´§äºº</label>
                                        <input type="text" class="form-input" name="recipient_name" placeholder="è¯·å¡«å†™æ”¶è´§äºº">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">æ‰‹æœºå·</label>
                                        <input type="text" class="form-input" name="phone" placeholder="è¯·å¡«å†™æ‰‹æœºå·">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">åŸå¸‚</label>
                                        <input type="text" class="form-input" name="city" placeholder="å¦‚ï¼šå—äº¬">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">åŒº/å®¿èˆæ¥¼</label>
                                        <input type="text" class="form-input" name="district" placeholder="å¦‚ï¼šä¹é¾™æ¹–å®¿èˆ A æ ‹">
                                    </div>
                                    <div class="form-group" style="grid-column:1 / -1;">
                                        <label class="form-label">è¯¦ç»†åœ°å€</label>
                                        <input type="text" class="form-input" name="detail" placeholder="æ¥¼å±‚ã€æˆ¿é—´å·ç­‰">
                                    </div>
                                    <div class="form-group" style="grid-column:1 / -1;">
                                        <label class="form-checkbox" style="display: inline-flex; align-items: center; gap: 8px;">
                                            <input type="checkbox" name="is_default"> è®¾ä¸ºé»˜è®¤åœ°å€
                                        </label>
                                    </div>
                                </div>
                                <div style="display:flex; gap: var(--spacing-sm); margin-top: var(--spacing-md);">
                                    <button type="button" id="save-address-btn" class="btn btn--primary">ä¿å­˜åœ°å€</button>
                                    <button type="button" id="cancel-address-btn" class="btn btn--secondary">å–æ¶ˆ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è´¦æˆ·è®¾ç½®æ ‡ç­¾ -->
            <div id="settings-tab" class="tab-content" style="display: none;">
                <div class="card" style="margin-bottom: var(--spacing-lg);">
                    <div class="card__header">
                        <h2 style="margin: 0;">ä¿®æ”¹å¯†ç </h2>
                    </div>
                    <div class="card__body">
                        <form id="change-password-form">
                            <div class="form-group">
                                <label class="form-label">å½“å‰å¯†ç </label>
                                <input type="password" name="current_password" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">æ–°å¯†ç </label>
                                <input type="password" name="new_password" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ç¡®è®¤æ–°å¯†ç </label>
                                <input type="password" name="confirm_password" class="form-input" required>
                            </div>
                            <button type="submit" class="btn btn--primary">ä¿®æ”¹å¯†ç </button>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card__header">
                        <h2 style="margin: 0;">å±é™©æ“ä½œ</h2>
                    </div>
                    <div class="card__body">
                        <button id="delete-account-btn" class="btn btn--danger">åˆ é™¤è´¦æˆ·</button>
                        <p class="text-muted" style="font-size: var(--font-size-sm); margin-top: var(--spacing-md);">
                            âš ï¸ åˆ é™¤è´¦æˆ·åï¼Œæ‰€æœ‰æ•°æ®å°†è¢«æ°¸ä¹…åˆ é™¤ï¼Œæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç¼–è¾‘èµ„æ–™å¼¹çª— -->
<div id="edit-profile-modal" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.45); backdrop-filter: blur(2px); z-index: 2000; align-items: center; justify-content: center;">
    <div style="background: var(--color-bg-primary); padding: var(--spacing-xl); border-radius: var(--radius-lg); width: 520px; max-width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.25);">
        <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: var(--spacing-md);">
            <h3 style="margin:0;">ç¼–è¾‘åŸºæœ¬ä¿¡æ¯</h3>
            <button id="close-edit-modal" class="btn btn--text">âœ•</button>
        </div>
        <div class="grid grid--cols-2" style="gap: var(--spacing-md);">
            <div class="form-group" style="grid-column:1 / -1;">
                <label class="form-label">ç”¨æˆ·å</label>
                <input type="text" id="edit-username" class="form-input" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
            </div>
            <div class="form-group" style="grid-column:1 / -1;">
                <label class="form-label">æ‰‹æœºå·</label>
                <input type="text" id="edit-phone" class="form-input" placeholder="è¯·è¾“å…¥æ‰‹æœºå·">
            </div>
        </div>
        <div style="display:flex; justify-content:flex-end; gap: var(--spacing-sm); margin-top: var(--spacing-md);">
            <button id="cancel-edit-btn" class="btn btn--secondary">å–æ¶ˆ</button>
            <button id="save-edit-btn" class="btn btn--primary">ä¿å­˜</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
/**
 * ä¸ªäººèµ„æ–™é¡µé¢é€»è¾‘
 */
class ProfilePage {
    constructor() {
        this.user = AuthManager.getUser();
        this.addresses = [];
        this.init();
    }

    async init() {
        // æ˜¾ç¤º/éšè—ç™»å½•æç¤ºå’Œå†…å®¹åŒºåŸŸ
        const loginRequired = document.getElementById('login-required');
        const profileContent = document.getElementById('profile-content');

        if (!this.user) {
            // æœªç™»å½•ï¼šæ˜¾ç¤ºç™»å½•æç¤ºï¼Œéšè—å†…å®¹
            loginRequired.style.display = 'block';
            profileContent.style.display = 'none';
            return;
        }

        // å·²ç™»å½•ï¼šæ˜¾ç¤ºå†…å®¹ï¼Œéšè—ç™»å½•æç¤º
        loginRequired.style.display = 'none';
        profileContent.style.display = 'block';

        this.renderProfile();
        this.setupEventListeners();
        await this.loadUserData();
    }

    renderProfile() {
        document.getElementById('profile-username').textContent = this.user.username;
        document.getElementById('profile-email').textContent = this.user.email;
        document.getElementById('profile-phone').textContent = this.user.phone || 'æœªå¡«å†™';
        const created = this.user.created_at ? new Date(this.user.created_at) : null;
        document.getElementById('profile-created-at').textContent = created ? created.toLocaleString('zh-CN') : 'æš‚æ— ';
        const avatar = this.user.avatar || this.user.avatar_url;
        const avatarEl = document.getElementById('profile-avatar');
        if (avatarEl) {
            avatarEl.src = avatar || "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'><rect width='120' height='120' rx='60' fill='%23e9edf3'/><circle cx='60' cy='48' r='22' fill='%23c9d2df'/><rect x='26' y='78' width='68' height='28' rx='14' fill='%23c9d2df'/></svg>";
        }
    }

    showEditModal() {
        const modal = document.getElementById('edit-profile-modal');
        modal.style.display = 'flex';
        const user = this.user || {};
        document.getElementById('edit-username').value = user.username || '';
        document.getElementById('edit-phone').value = user.phone || '';
    }

    hideEditModal() {
        document.getElementById('edit-profile-modal').style.display = 'none';
    }

    async saveProfileFromModal() {
        const payload = {
            nickname: document.getElementById('edit-username').value.trim(),
            phone: document.getElementById('edit-phone').value.trim(),
        };

        LoadingManager.show('æ­£åœ¨ä¿å­˜èµ„æ–™...');
        try {
            const resp = await API.user.updateProfile(payload);
            if (resp.data) {
                this.user = resp.data;
                AuthManager.setUser(resp.data);
                this.renderProfile();
                await this.loadUserData();
                NotificationManager.success('èµ„æ–™å·²æ›´æ–°');
                this.hideEditModal();
            }
        } catch (error) {
            NotificationManager.error(error?.data?.message || 'ä¿å­˜å¤±è´¥');
        } finally {
            LoadingManager.hide();
        }
    }

    async loadUserData() {
        try {
            const response = await API.user.getCurrentUser();
            const user = response.data;
            this.user = user;
            AuthManager.setUser(user);

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('stats-published').textContent = user.stats?.published || 0;
            document.getElementById('stats-sold').textContent = user.stats?.sold || 0;
            document.getElementById('stats-favorites').textContent = user.stats?.favorites || 0;
            document.getElementById('profile-rating').textContent = (user.rating || 5.0).toFixed(1);

            this.renderProfile();
            // åŠ è½½è®¢å•
            this.loadOrders();
            // åŠ è½½å‘å¸ƒ
            this.loadPublished();
            // åŠ è½½åœ°å€
            this.loadAddresses();
        } catch (error) {
            console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
            // æœªç™»å½•æˆ–Tokenæ— æ•ˆï¼šæ˜¾ç¤ºç™»å½•æç¤ºï¼Œéšè—å†…å®¹
            if (error.statusCode === 401 || error.type === 'AUTH_ERROR' || error.message?.includes('ç™»å½•')) {
                const loginRequired = document.getElementById('login-required');
                const profileContent = document.getElementById('profile-content');
                loginRequired.style.display = 'block';
                profileContent.style.display = 'none';
                return;
            }
        }
    }

    async loadOrders() {
        try {
            const response = await API.order.getUserOrders({ page: 1, limit: 10 });
            const orders = response.data?.orders || [];

            if (orders.length === 0) {
                document.getElementById('orders-empty').style.display = 'block';
                document.getElementById('orders-list').style.display = 'none';
            } else {
                document.getElementById('orders-list').style.display = 'block';
                document.getElementById('orders-empty').style.display = 'none';

                const tbody = document.getElementById('orders-tbody');
                tbody.innerHTML = orders.map(order => {
                    const amount = Number(order.total_amount ?? order.total_price ?? 0);
                    const safeAmount = Number.isFinite(amount) ? amount.toFixed(2) : '0.00';
                    const statusText = order.status_text || order.status || 'æœªçŸ¥';
                    const itemsCount = order.items?.length || 0;
                    const canCancel = (order.status === 'pending');
                    return `
                    <tr>
                        <td>#${order.id}</td>
                        <td>${itemsCount} ä»¶å•†å“</td>
                        <td>Â¥${safeAmount}</td>
                        <td><span class="badge badge--primary">${statusText}</span></td>
                        <td>
                            <div style="display:flex; gap: var(--spacing-xs); flex-wrap: wrap;">
                                <button class="btn btn--secondary btn--sm" data-action="detail" data-id="${order.id}">æŸ¥çœ‹è¯¦æƒ…</button>
                                ${canCancel ? `<button class="btn btn--danger btn--sm" data-action="cancel" data-id="${order.id}">å–æ¶ˆè®¢å•</button>` : ''}
                            </div>
                        </td>
                    </tr>
                    <tr class="order-detail-row" data-order-id="${order.id}" style="display: none;">
                        <td colspan="5">
                            <div class="order-detail" data-loaded="false" style="background: var(--color-bg-soft); padding: var(--spacing-md); border-radius: 8px;">
                                <div class="text-muted">ç‚¹å‡»â€œæŸ¥çœ‹è¯¦æƒ…â€åŠ è½½è®¢å•æ˜ç»†</div>
                            </div>
                        </td>
                    </tr>
                    `;
                }).join('');

                tbody.querySelectorAll('[data-action="detail"]').forEach(btn => {
                    btn.addEventListener('click', (e) => this.toggleOrderDetail(e.currentTarget.dataset.id, e.currentTarget));
                });
                tbody.querySelectorAll('[data-action="cancel"]').forEach(btn => {
                    btn.addEventListener('click', (e) => this.cancelOrder(e.currentTarget.dataset.id));
                });
            }
        } catch (error) {
            console.error('åŠ è½½è®¢å•å¤±è´¥:', error);
        }
    }

    async toggleOrderDetail(orderId, triggerBtn) {
        const detailRow = document.querySelector(`.order-detail-row[data-order-id="${orderId}"]`);
        if (!detailRow) return;

        const detailBox = detailRow.querySelector('.order-detail');
        const isOpen = detailRow.style.display !== 'none';

        if (isOpen) {
            detailRow.style.display = 'none';
            if (triggerBtn) triggerBtn.textContent = 'æŸ¥çœ‹è¯¦æƒ…';
            return;
        }

        detailRow.style.display = 'table-row';
        if (triggerBtn) triggerBtn.textContent = 'æ”¶èµ·';

        if (detailBox.dataset.loaded === 'true') return;

        detailBox.innerHTML = '<div class="text-muted">æ­£åœ¨åŠ è½½è®¢å•æ˜ç»†...</div>';
        try {
            const resp = await API.order.getDetail(orderId);
            const detail = resp.data || {};
            detailBox.dataset.loaded = 'true';
            detailBox.innerHTML = this.renderOrderDetail(detail);
        } catch (error) {
            console.error('åŠ è½½è®¢å•è¯¦æƒ…å¤±è´¥:', error);
            detailBox.innerHTML = '<div class="text-muted">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åå†è¯•</div>';
        }
    }

    renderOrderDetail(detail) {
        const items = Array.isArray(detail.items) ? detail.items : [];
        const visibleItems = items.slice(0, 2);
        const hiddenCount = items.length - visibleItems.length;
        const itemsHtml = visibleItems.length ? visibleItems.map(item => {
            const unitPrice = Number(item.unit_price ?? item.price_at_purchase ?? item.price ?? 0);
            const safeUnit = Number.isFinite(unitPrice) ? unitPrice.toFixed(2) : '0.00';
            return `
            <div style="display:flex; justify-content: space-between; align-items:center; padding: var(--spacing-xs) 0; border-bottom: 1px dashed var(--color-border);">
                <div class="font-semibold">${item.title || 'å•†å“å·²åˆ é™¤'}</div>
                <div class="text-muted" style="font-size: var(--font-size-sm);">${item.quantity || 0} Ã— Â¥${safeUnit}</div>
            </div>
            `;
        }).join('') : '<div class="text-muted">æš‚æ— å•†å“æ˜ç»†</div>';

        const createdAt = detail.created_at ? new Date(detail.created_at).toLocaleString('zh-CN') : 'æš‚æ— ';
        const address = detail.shipping_address || 'æš‚æ— ';
        const moreTip = hiddenCount > 0 ? `<div class="text-muted" style="font-size: var(--font-size-sm); margin-top: var(--spacing-xs);">å…¶ä½™ ${hiddenCount} ä»¶å•†å“å·²çœç•¥</div>` : '';

        return `
        <div style="display:flex; flex-direction: column; gap: var(--spacing-sm);">
            <div style="display:flex; flex-wrap: wrap; gap: var(--spacing-lg);">
                <div><span class="text-muted">è®¢å•çŠ¶æ€ï¼š</span>${detail.status_text || detail.status || 'æœªçŸ¥'}</div>
                <div><span class="text-muted">ä¸‹å•æ—¶é—´ï¼š</span>${createdAt}</div>
            </div>
            <div><span class="text-muted">æ”¶è´§åœ°å€ï¼š</span>${address}</div>
            <div>${itemsHtml}${moreTip}</div>
        </div>
        `;
    }

    async cancelOrder(orderId) {
        const confirmed = window.confirm('ç¡®å®šå–æ¶ˆè¯¥è®¢å•å—ï¼Ÿå–æ¶ˆååº“å­˜å°†æ¢å¤ä¸Šæ¶ã€‚');
        if (!confirmed) return;

        LoadingManager.show('æ­£åœ¨å–æ¶ˆè®¢å•...');
        try {
            await API.order.cancel(orderId);
            NotificationManager.success('è®¢å•å·²å–æ¶ˆï¼Œåº“å­˜å·²æ¢å¤');
            await this.loadOrders();
        } catch (error) {
            NotificationManager.error(error?.data?.message || 'å–æ¶ˆå¤±è´¥');
        } finally {
            LoadingManager.hide();
        }
    }

    async loadPublished() {
        try {
            const response = await API.item.getUserItems(this.user.id, { page: 1, limit: 6 });
            const items = (response.data && response.data.items) || response.data || [];

            if (items.length === 0) {
                document.getElementById('published-empty').style.display = 'block';
                document.getElementById('published-list').style.display = 'none';
            } else {
                document.getElementById('published-list').style.display = 'block';
                document.getElementById('published-empty').style.display = 'none';

                const container = document.getElementById('published-items');
                container.innerHTML = items.map(item => {
                    const imageHtml = item.image
                        ? `<img src="${item.image}" alt="${item.title}" class="product-card__image">`
                        : `<div class="product-card__image product-card__image--empty"><span>æš‚æ— å›¾ç‰‡</span></div>`;
                    return `
                    <a href="/items/${item.id}" class="product-card" style="text-decoration: none; color: inherit;">
                        ${imageHtml}
                        <div class="product-card__content">
                            <h3 class="product-card__title">${item.title}</h3>
                            <div class="product-card__price">Â¥${item.price?.toFixed ? item.price.toFixed(2) : item.price}</div>
                            <div class="text-sm text-muted">åº“å­˜: ${item.stock}</div>
                        </div>
                    </a>
                    `;
                }).join('');
            }
        } catch (error) {
            console.error('åŠ è½½å‘å¸ƒå¤±è´¥:', error);
        }
    }

    async loadAddresses() {
        try {
            const resp = await API.address.getList();
            this.addresses = Array.isArray(resp.data) ? resp.data : (resp.data?.items || []);
            this.renderAddresses();
        } catch (error) {
            console.error('åŠ è½½åœ°å€å¤±è´¥:', error);
        }
    }

    renderAddresses() {
        const listEl = document.getElementById('addresses-list');
        const emptyEl = document.getElementById('addresses-empty');

        if (!this.addresses.length) {
            listEl.innerHTML = '';
            emptyEl.style.display = 'block';
            listEl.style.display = 'none';
            return;
        }

        emptyEl.style.display = 'none';
        listEl.style.display = 'grid';
        listEl.innerHTML = this.addresses.map(addr => `
            <div class="card" style="padding: var(--spacing-md); position: relative;">
                ${addr.is_default ? '<span class="badge badge--primary" style="position:absolute; top:12px; right:12px;">é»˜è®¤</span>' : ''}
                <div class="font-semibold" style="margin-bottom: var(--spacing-xs);">${addr.recipient_name} ${addr.phone}</div>
                <div class="text-muted" style="font-size: var(--font-size-sm);">${addr.full_address || addr.detail}</div>
                <div style="display:flex; gap: var(--spacing-sm); margin-top: var(--spacing-sm);">
                    <button class="btn btn--secondary btn--sm" data-action="default" data-id="${addr.id}">è®¾ä¸ºé»˜è®¤</button>
                    <button class="btn btn--danger btn--sm" data-action="delete" data-id="${addr.id}">åˆ é™¤</button>
                </div>
            </div>
        `).join('');

        listEl.querySelectorAll('[data-action="default"]').forEach(btn => {
            btn.addEventListener('click', (e) => this.setDefaultAddress(e.target.dataset.id));
        });
        listEl.querySelectorAll('[data-action="delete"]').forEach(btn => {
            btn.addEventListener('click', (e) => this.deleteAddress(e.target.dataset.id));
        });
    }

    async setDefaultAddress(addressId) {
        LoadingManager.show('æ­£åœ¨è®¾ç½®é»˜è®¤åœ°å€...');
        try {
            const resp = await API.address.setDefault(addressId);
            if (resp.data) {
                this.addresses = this.addresses.map(addr => ({
                    ...addr,
                    is_default: addr.id === resp.data.id
                }));
                this.renderAddresses();
                NotificationManager.success('å·²è®¾ä¸ºé»˜è®¤åœ°å€');
            }
        } catch (error) {
            NotificationManager.error(error?.data?.message || 'æ“ä½œå¤±è´¥');
        } finally {
            LoadingManager.hide();
        }
    }

    async deleteAddress(addressId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥åœ°å€å—ï¼Ÿ')) return;
        LoadingManager.show('æ­£åœ¨åˆ é™¤åœ°å€...');
        try {
            await API.address.delete(addressId);
            this.addresses = this.addresses.filter(addr => String(addr.id) !== String(addressId));
            this.renderAddresses();
            NotificationManager.success('åœ°å€å·²åˆ é™¤');
        } catch (error) {
            NotificationManager.error(error?.data?.message || 'åˆ é™¤å¤±è´¥');
        } finally {
            LoadingManager.hide();
        }
    }

    async saveAddressFromForm() {
        const form = document.getElementById('address-form');
        const getVal = (name) => form.querySelector(`[name="${name}"]`).value.trim();
        const payload = {
            recipient_name: getVal('recipient_name'),
            phone: getVal('phone'),
            city: getVal('city'),
            district: getVal('district'),
            detail: getVal('detail'),
            is_default: form.querySelector('[name="is_default"]').checked,
        };

        if (!payload.recipient_name || !payload.phone || !payload.city || !payload.district || !payload.detail) {
            NotificationManager.error('è¯·å®Œæ•´å¡«å†™åœ°å€ä¿¡æ¯');
            return;
        }

        LoadingManager.show('æ­£åœ¨ä¿å­˜åœ°å€...');
        try {
            const resp = await API.address.add(payload);
            if (resp.data) {
                const saved = {
                    ...resp.data,
                    full_address: `${resp.data.city || ''}${resp.data.district || ''}${resp.data.detail || ''}`
                };
                let next = [saved, ...this.addresses];
                if (saved.is_default) {
                    next = next.map(addr => ({ ...addr, is_default: addr.id === saved.id }));
                }
                this.addresses = next;
                this.renderAddresses();
                this.toggleAddressForm(false);
                NotificationManager.success('åœ°å€å·²æ·»åŠ ');
            }
        } catch (error) {
            NotificationManager.error(error?.data?.message || 'ä¿å­˜å¤±è´¥');
        } finally {
            LoadingManager.hide();
        }
    }

    toggleAddressForm(show) {
        const form = document.getElementById('address-form');
        form.style.display = show ? 'block' : 'none';
        if (!show) {
            form.querySelectorAll('input').forEach(input => {
                if (input.type === 'checkbox') {
                    input.checked = false;
                } else {
                    input.value = '';
                }
            });
        }
    }

    setupEventListeners() {
        // æ ‡ç­¾é¡µåˆ‡æ¢
        document.querySelectorAll('.tab-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const tabName = e.currentTarget.getAttribute('href').slice(1);

                document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('is-active'));
                document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');

                e.currentTarget.classList.add('is-active');
                document.getElementById(tabName + '-tab').style.display = 'block';
            });
        });

        // ç¼–è¾‘èµ„æ–™å¼¹çª—
        document.getElementById('edit-profile-btn').addEventListener('click', () => this.showEditModal());
        document.getElementById('cancel-edit-btn').addEventListener('click', () => this.hideEditModal());
        document.getElementById('close-edit-modal').addEventListener('click', () => this.hideEditModal());
        document.getElementById('save-edit-btn').addEventListener('click', () => this.saveProfileFromModal());

        // åœ°å€è¡¨å•
        document.getElementById('add-address-btn').addEventListener('click', () => this.toggleAddressForm(true));
        document.getElementById('cancel-address-btn').addEventListener('click', () => this.toggleAddressForm(false));
        document.getElementById('save-address-btn').addEventListener('click', () => this.saveAddressFromForm());

        // æ›´æ¢å¤´åƒ
        document.getElementById('change-avatar-btn').addEventListener('click', () => {
            document.getElementById('avatar-file-input').click();
        });

        document.getElementById('avatar-file-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                await this.uploadAvatar(file);
                e.target.value = '';
            }
        });

        // ä¿®æ”¹å¯†ç 
        document.getElementById('change-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            NotificationManager.info('ä¿®æ”¹å¯†ç åŠŸèƒ½å¼€å‘ä¸­');
        });

        // åˆ é™¤è´¦æˆ·
        document.getElementById('delete-account-btn').addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦åˆ é™¤è´¦æˆ·å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
                NotificationManager.info('åˆ é™¤è´¦æˆ·åŠŸèƒ½å¼€å‘ä¸­');
            }
        });
    }

    async uploadAvatar(file) {
        LoadingManager.show('æ­£åœ¨ä¸Šä¼ å¤´åƒ...');
        try {
            const uploadResp = await API.upload.uploadImage(file, 'avatar');
            const url = uploadResp.data?.url;
            if (!url) throw new Error('ä¸Šä¼ å¤±è´¥');
            await API.user.updateProfile({ avatar: url });
            await this.loadUserData();
            NotificationManager.success('å¤´åƒå·²æ›´æ–°');
        } catch (error) {
            NotificationManager.error(error?.data?.message || 'ä¸Šä¼ å¤±è´¥');
        } finally {
            LoadingManager.hide();
        }
    }
}

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    new ProfilePage();
});
</script>
{% endblock %}
