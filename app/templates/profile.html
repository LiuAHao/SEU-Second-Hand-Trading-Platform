{% extends "base.html" %}

{% block title %}个人资料 - 东南大学校园二手交易平台{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <h1>个人中心</h1>
        <p style="color: rgba(255, 255, 255, 0.9); margin-bottom: 0;">管理您的账户和订单信息</p>
    </div>
</div>

<!-- 未登录提示 -->
<div id="login-required" class="container" style="display: none;">
    <div class="card">
        <div class="card__body" style="text-align: center; padding: var(--spacing-2xl);">
            <div style="font-size: 64px; margin-bottom: var(--spacing-lg);">🔒</div>
            <h2>请先登录</h2>
            <p style="color: var(--color-text-secondary); margin-bottom: var(--spacing-xl);">您需要登录后才能查看个人资料</p>
            <a href="/login?redirect=/profile" class="btn btn--primary btn--lg">立即登录</a>
        </div>
    </div>
</div>

<!-- 已登录内容 -->
<div id="profile-content" class="container" style="display: none;">
    <div class="grid grid--cols-4">
        <!-- 左侧菜单 -->
        <div style="grid-column: 1 / 2;">
            <div class="card" style="position: sticky; top: 80px;">
                <div class="card__body" style="padding: 0;">
                    <a href="#profile" class="tab-link is-active" style="display: block; padding: var(--spacing-md) var(--spacing-lg); border-bottom: 1px solid var(--color-border); cursor: pointer;">👤 基本信息</a>
                    <a href="#orders" class="tab-link" style="display: block; padding: var(--spacing-md) var(--spacing-lg); border-bottom: 1px solid var(--color-border); cursor: pointer;">📦 我的订单</a>
                    <a href="#published" class="tab-link" style="display: block; padding: var(--spacing-md) var(--spacing-lg); border-bottom: 1px solid var(--color-border); cursor: pointer;">📄 我的发布</a>
                    <a href="#addresses" class="tab-link" style="display: block; padding: var(--spacing-md) var(--spacing-lg); border-bottom: 1px solid var(--color-border); cursor: pointer;">📮 收货地址</a>
                    <a href="#settings" class="tab-link" style="display: block; padding: var(--spacing-md) var(--spacing-lg); cursor: pointer;">⚙️ 账户设置</a>
                </div>
            </div>
        </div>

        <!-- 右侧内容 -->
        <div style="grid-column: 2 / -1;">
            <!-- 基本信息标签 -->
            <div id="profile-tab" class="tab-content is-active">
                <div class="card" style="margin-bottom: var(--spacing-lg);">
                    <div class="card__header">
                        <h2 style="margin: 0;">基本信息</h2>
                    </div>
                    <div class="card__body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-2xl); margin-bottom: var(--spacing-2xl);">
                            <!-- 头像 -->
                            <div style="text-align: center;">
                                <div style="width: 120px; height: 120px; border-radius: 50%; background: var(--color-bg-tertiary); display: flex; align-items: center; justify-content: center; overflow: hidden; margin: 0 auto var(--spacing-md);">
                                    <img id="profile-avatar" src="/static/images/placeholder.png" alt="头像" style="width:100%; height:100%; object-fit: cover;">
                                </div>
                                <input type="file" id="avatar-file-input" accept="image/*" style="display:none;">
                                <button id="change-avatar-btn" class="btn btn--secondary btn--sm">更换头像</button>
                            </div>

                            <!-- 信息 -->
                            <div>
                                <div style="margin-bottom: var(--spacing-lg);">
                                    <div class="text-muted" style="font-size: var(--font-size-sm); margin-bottom: var(--spacing-sm);">用户名</div>
                                    <div class="font-semibold" id="profile-username"></div>
                                </div>
                                <div style="margin-bottom: var(--spacing-lg);">
                                    <div class="text-muted" style="font-size: var(--font-size-sm); margin-bottom: var(--spacing-sm);">邮箱</div>
                                    <div class="font-semibold" id="profile-email"></div>
                                </div>
                                <div style="margin-bottom: var(--spacing-lg);">
                                    <div class="text-muted" style="font-size: var(--font-size-sm); margin-bottom: var(--spacing-sm);">手机号</div>
                                    <div class="font-semibold" id="profile-phone">未填写</div>
                                </div>
                                <div style="margin-bottom: var(--spacing-lg);">
                                    <div class="text-muted" style="font-size: var(--font-size-sm); margin-bottom: var(--spacing-sm);">注册时间</div>
                                    <div class="font-semibold" id="profile-created-at"></div>
                                </div>
                                <div style="margin-bottom: var(--spacing-lg);">
                                    <div class="text-muted" style="font-size: var(--font-size-sm); margin-bottom: var(--spacing-sm);">信用评分</div>
                                    <div class="font-semibold">
                                        <span id="profile-rating">5.0</span> ⭐
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 编辑按钮 -->
                        <button id="edit-profile-btn" class="btn btn--primary">编辑基本信息</button>
                    </div>
                </div>

                <!-- 统计信息 -->
                <div class="grid grid--cols-3">
                    <div class="card" style="text-align: center; padding: var(--spacing-lg);">
                        <div style="font-size: 32px; margin-bottom: var(--spacing-md);">📦</div>
                        <div class="text-muted" style="font-size: var(--font-size-sm); margin-bottom: var(--spacing-sm);">已发布</div>
                        <div class="font-bold" style="font-size: var(--font-size-2xl); color: var(--color-primary);" id="stats-published">0</div>
                    </div>
                    <div class="card" style="text-align: center; padding: var(--spacing-lg);">
                        <div style="font-size: 32px; margin-bottom: var(--spacing-md);">✅</div>
                        <div class="text-muted" style="font-size: var(--font-size-sm); margin-bottom: var(--spacing-sm);">已售出</div>
                        <div class="font-bold" style="font-size: var(--font-size-2xl); color: var(--color-success);" id="stats-sold">0</div>
                    </div>
                    <div class="card" style="text-align: center; padding: var(--spacing-lg);">
                        <div style="font-size: 32px; margin-bottom: var(--spacing-md);">❤️</div>
                        <div class="text-muted" style="font-size: var(--font-size-sm); margin-bottom: var(--spacing-sm);">收藏数</div>
                        <div class="font-bold" style="font-size: var(--font-size-2xl); color: var(--color-error);" id="stats-favorites">0</div>
                    </div>
                </div>
            </div>

            <!-- 我的订单标签 -->
            <div id="orders-tab" class="tab-content" style="display: none;">
                <div class="card">
                    <div class="card__header">
                        <h2 style="margin: 0;">我的订单</h2>
                    </div>
                    <div class="card__body">
                        <div id="orders-list" style="display: none;">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>订单号</th>
                                        <th>商品</th>
                                        <th>金额</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="orders-tbody">
                                    <!-- 动态填充 -->
                                </tbody>
                            </table>
                        </div>
                        <div id="orders-empty" class="empty-state">
                            <div class="empty-state__icon">📭</div>
                            <div class="empty-state__title">暂无订单</div>
                            <p class="empty-state__description">您还没有购买过任何商品</p>
                            <a href="/" class="btn btn--primary">开始购物</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 我的发布标签 -->
            <div id="published-tab" class="tab-content" style="display: none;">
                <div class="card" style="margin-bottom: var(--spacing-lg);">
                    <div class="card__header">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h2 style="margin: 0;">我的发布</h2>
                            <a href="/publish-item" class="btn btn--primary btn--sm">+ 发布新商品</a>
                        </div>
                    </div>
                    <div class="card__body">
                        <div id="published-list" style="display: none;">
                            <div class="grid grid--cols-3" id="published-items">
                                <!-- 动态填充 -->
                            </div>
                        </div>
                        <div id="published-empty" class="empty-state">
                            <div class="empty-state__icon">📄</div>
                            <div class="empty-state__title">暂无发布</div>
                            <p class="empty-state__description">您还没有发布过任何商品</p>
                            <a href="/publish-item" class="btn btn--primary">立即发布</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 收货地址标签 -->
            <div id="addresses-tab" class="tab-content" style="display: none;">
                <div class="card">
                    <div class="card__header" style="display:flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0;">收货地址</h2>
                        <button id="add-address-btn" class="btn btn--primary btn--sm">+ 添加地址</button>
                    </div>
                    <div class="card__body">
                        <div id="addresses-list" class="grid grid--cols-2" style="gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                            <div class="skeleton" style="height: 120px;"></div>
                            <div class="skeleton" style="height: 120px;"></div>
                        </div>
                        <div id="addresses-empty" class="empty-state" style="display:none;">
                            <div class="empty-state__icon">📮</div>
                            <div class="empty-state__title">暂无收货地址</div>
                            <p class="empty-state__description">添加一个收货地址以便快速下单</p>
                        </div>

                        <div id="address-form" class="card" style="display:none; margin-top: var(--spacing-lg);">
                            <div class="card__header">
                                <h3 style="margin:0;">新增地址</h3>
                            </div>
                            <div class="card__body">
                                <div class="grid grid--cols-2">
                                    <div class="form-group">
                                        <label class="form-label">收货人</label>
                                        <input type="text" class="form-input" name="recipient_name" placeholder="请填写收货人">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">手机号</label>
                                        <input type="text" class="form-input" name="phone" placeholder="请填写手机号">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">城市</label>
                                        <input type="text" class="form-input" name="city" placeholder="如：南京">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">区/宿舍楼</label>
                                        <input type="text" class="form-input" name="district" placeholder="如：九龙湖宿舍 A 栋">
                                    </div>
                                    <div class="form-group" style="grid-column:1 / -1;">
                                        <label class="form-label">详细地址</label>
                                        <input type="text" class="form-input" name="detail" placeholder="楼层、房间号等">
                                    </div>
                                    <div class="form-group" style="grid-column:1 / -1;">
                                        <label class="form-checkbox" style="display: inline-flex; align-items: center; gap: 8px;">
                                            <input type="checkbox" name="is_default"> 设为默认地址
                                        </label>
                                    </div>
                                </div>
                                <div style="display:flex; gap: var(--spacing-sm); margin-top: var(--spacing-md);">
                                    <button type="button" id="save-address-btn" class="btn btn--primary">保存地址</button>
                                    <button type="button" id="cancel-address-btn" class="btn btn--secondary">取消</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 账户设置标签 -->
            <div id="settings-tab" class="tab-content" style="display: none;">
                <div class="card" style="margin-bottom: var(--spacing-lg);">
                    <div class="card__header">
                        <h2 style="margin: 0;">修改密码</h2>
                    </div>
                    <div class="card__body">
                        <form id="change-password-form">
                            <div class="form-group">
                                <label class="form-label">当前密码</label>
                                <input type="password" name="current_password" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">新密码</label>
                                <input type="password" name="new_password" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">确认新密码</label>
                                <input type="password" name="confirm_password" class="form-input" required>
                            </div>
                            <button type="submit" class="btn btn--primary">修改密码</button>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card__header">
                        <h2 style="margin: 0;">危险操作</h2>
                    </div>
                    <div class="card__body">
                        <button id="delete-account-btn" class="btn btn--danger">删除账户</button>
                        <p class="text-muted" style="font-size: var(--font-size-sm); margin-top: var(--spacing-md);">
                            ⚠️ 删除账户后，所有数据将被永久删除，此操作无法撤销。
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 编辑资料弹窗 -->
<div id="edit-profile-modal" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.45); backdrop-filter: blur(2px); z-index: 2000; align-items: center; justify-content: center;">
    <div style="background: var(--color-bg-primary); padding: var(--spacing-xl); border-radius: var(--radius-lg); width: 520px; max-width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.25);">
        <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: var(--spacing-md);">
            <h3 style="margin:0;">编辑基本信息</h3>
            <button id="close-edit-modal" class="btn btn--text">✕</button>
        </div>
        <div class="grid grid--cols-2" style="gap: var(--spacing-md);">
            <div class="form-group" style="grid-column:1 / -1;">
                <label class="form-label">用户名</label>
                <input type="text" id="edit-username" class="form-input" placeholder="请输入用户名">
            </div>
            <div class="form-group" style="grid-column:1 / -1;">
                <label class="form-label">手机号</label>
                <input type="text" id="edit-phone" class="form-input" placeholder="请输入手机号">
            </div>
        </div>
        <div style="display:flex; justify-content:flex-end; gap: var(--spacing-sm); margin-top: var(--spacing-md);">
            <button id="cancel-edit-btn" class="btn btn--secondary">取消</button>
            <button id="save-edit-btn" class="btn btn--primary">保存</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
/**
 * 个人资料页面逻辑
 */
class ProfilePage {
    constructor() {
        this.user = AuthManager.getUser();
        this.addresses = [];
        this.init();
    }

    async init() {
        // 显示/隐藏登录提示和内容区域
        const loginRequired = document.getElementById('login-required');
        const profileContent = document.getElementById('profile-content');

        if (!this.user) {
            // 未登录：显示登录提示，隐藏内容
            loginRequired.style.display = 'block';
            profileContent.style.display = 'none';
            return;
        }

        // 已登录：显示内容，隐藏登录提示
        loginRequired.style.display = 'none';
        profileContent.style.display = 'block';

        this.renderProfile();
        this.setupEventListeners();
        await this.loadUserData();
    }

    renderProfile() {
        document.getElementById('profile-username').textContent = this.user.username;
        document.getElementById('profile-email').textContent = this.user.email;
        document.getElementById('profile-phone').textContent = this.user.phone || '未填写';
        const created = this.user.created_at ? new Date(this.user.created_at) : null;
        document.getElementById('profile-created-at').textContent = created ? created.toLocaleString('zh-CN') : '暂无';
        const avatar = this.user.avatar || this.user.avatar_url;
        const avatarEl = document.getElementById('profile-avatar');
        if (avatarEl) {
            avatarEl.src = avatar || '/static/images/placeholder.png';
        }
    }

    showEditModal() {
        const modal = document.getElementById('edit-profile-modal');
        modal.style.display = 'flex';
        const user = this.user || {};
        document.getElementById('edit-username').value = user.username || '';
        document.getElementById('edit-phone').value = user.phone || '';
    }

    hideEditModal() {
        document.getElementById('edit-profile-modal').style.display = 'none';
    }

    async saveProfileFromModal() {
        const payload = {
            nickname: document.getElementById('edit-username').value.trim(),
            phone: document.getElementById('edit-phone').value.trim(),
        };

        LoadingManager.show('正在保存资料...');
        try {
            const resp = await API.user.updateProfile(payload);
            if (resp.data) {
                this.user = resp.data;
                AuthManager.setUser(resp.data);
                this.renderProfile();
                await this.loadUserData();
                NotificationManager.success('资料已更新');
                this.hideEditModal();
            }
        } catch (error) {
            NotificationManager.error(error?.data?.message || '保存失败');
        } finally {
            LoadingManager.hide();
        }
    }

    async loadUserData() {
        try {
            const response = await API.user.getCurrentUser();
            const user = response.data;
            this.user = user;
            AuthManager.setUser(user);

            // 更新统计信息
            document.getElementById('stats-published').textContent = user.stats?.published || 0;
            document.getElementById('stats-sold').textContent = user.stats?.sold || 0;
            document.getElementById('stats-favorites').textContent = user.stats?.favorites || 0;
            document.getElementById('profile-rating').textContent = (user.rating || 5.0).toFixed(1);

            this.renderProfile();
            // 加载订单
            this.loadOrders();
            // 加载发布
            this.loadPublished();
            // 加载地址
            this.loadAddresses();
        } catch (error) {
            console.error('加载用户数据失败:', error);
            // 未登录或Token无效：显示登录提示，隐藏内容
            if (error.statusCode === 401 || error.type === 'AUTH_ERROR' || error.message?.includes('登录')) {
                const loginRequired = document.getElementById('login-required');
                const profileContent = document.getElementById('profile-content');
                loginRequired.style.display = 'block';
                profileContent.style.display = 'none';
                return;
            }
        }
    }

    async loadOrders() {
        try {
            const response = await API.order.getUserOrders({ page: 1, limit: 10 });
            const orders = response.data?.orders || [];

            if (orders.length === 0) {
                document.getElementById('orders-empty').style.display = 'block';
                document.getElementById('orders-list').style.display = 'none';
            } else {
                document.getElementById('orders-list').style.display = 'block';
                document.getElementById('orders-empty').style.display = 'none';

                const tbody = document.getElementById('orders-tbody');
                tbody.innerHTML = orders.map(order => `
                    <tr>
                        <td>#${order.id}</td>
                        <td>${order.items?.length || 0} 件商品</td>
                        <td>¥${order.total_price.toFixed(2)}</td>
                        <td><span class="badge badge--primary">${order.status}</span></td>
                        <td><a href="/orders/${order.id}" class="btn btn--text">查看详情</a></td>
                    </tr>
                `).join('');
            }
        } catch (error) {
            console.error('加载订单失败:', error);
        }
    }

    async loadPublished() {
        try {
            const response = await API.item.getUserItems(this.user.id, { page: 1, limit: 6 });
            const items = (response.data && response.data.items) || response.data || [];

            if (items.length === 0) {
                document.getElementById('published-empty').style.display = 'block';
                document.getElementById('published-list').style.display = 'none';
            } else {
                document.getElementById('published-list').style.display = 'block';
                document.getElementById('published-empty').style.display = 'none';

                const container = document.getElementById('published-items');
                container.innerHTML = items.map(item => `
                    <a href="/items/${item.id}" class="product-card" style="text-decoration: none; color: inherit;">
                        <img src="${item.image || '/static/images/placeholder.png'}" alt="${item.title}" class="product-card__image">
                        <div class="product-card__content">
                            <h3 class="product-card__title">${item.title}</h3>
                               <div class="product-card__price">¥${item.price?.toFixed ? item.price.toFixed(2) : item.price}</div>
                            <div class="text-sm text-muted">库存: ${item.stock}</div>
                        </div>
                    </a>
                `).join('');
            }
        } catch (error) {
            console.error('加载发布失败:', error);
        }
    }

    async loadAddresses() {
        try {
            const resp = await API.address.getList();
            this.addresses = Array.isArray(resp.data) ? resp.data : (resp.data?.items || []);
            this.renderAddresses();
        } catch (error) {
            console.error('加载地址失败:', error);
        }
    }

    renderAddresses() {
        const listEl = document.getElementById('addresses-list');
        const emptyEl = document.getElementById('addresses-empty');

        if (!this.addresses.length) {
            listEl.innerHTML = '';
            emptyEl.style.display = 'block';
            listEl.style.display = 'none';
            return;
        }

        emptyEl.style.display = 'none';
        listEl.style.display = 'grid';
        listEl.innerHTML = this.addresses.map(addr => `
            <div class="card" style="padding: var(--spacing-md); position: relative;">
                ${addr.is_default ? '<span class="badge badge--primary" style="position:absolute; top:12px; right:12px;">默认</span>' : ''}
                <div class="font-semibold" style="margin-bottom: var(--spacing-xs);">${addr.recipient_name} ${addr.phone}</div>
                <div class="text-muted" style="font-size: var(--font-size-sm);">${addr.full_address || addr.detail}</div>
                <div style="display:flex; gap: var(--spacing-sm); margin-top: var(--spacing-sm);">
                    <button class="btn btn--secondary btn--sm" data-action="default" data-id="${addr.id}">设为默认</button>
                    <button class="btn btn--danger btn--sm" data-action="delete" data-id="${addr.id}">删除</button>
                </div>
            </div>
        `).join('');

        listEl.querySelectorAll('[data-action="default"]').forEach(btn => {
            btn.addEventListener('click', (e) => this.setDefaultAddress(e.target.dataset.id));
        });
        listEl.querySelectorAll('[data-action="delete"]').forEach(btn => {
            btn.addEventListener('click', (e) => this.deleteAddress(e.target.dataset.id));
        });
    }

    async setDefaultAddress(addressId) {
        LoadingManager.show('正在设置默认地址...');
        try {
            const resp = await API.address.setDefault(addressId);
            if (resp.data) {
                this.addresses = this.addresses.map(addr => ({
                    ...addr,
                    is_default: addr.id === resp.data.id
                }));
                this.renderAddresses();
                NotificationManager.success('已设为默认地址');
            }
        } catch (error) {
            NotificationManager.error(error?.data?.message || '操作失败');
        } finally {
            LoadingManager.hide();
        }
    }

    async deleteAddress(addressId) {
        if (!confirm('确定要删除该地址吗？')) return;
        LoadingManager.show('正在删除地址...');
        try {
            await API.address.delete(addressId);
            this.addresses = this.addresses.filter(addr => String(addr.id) !== String(addressId));
            this.renderAddresses();
            NotificationManager.success('地址已删除');
        } catch (error) {
            NotificationManager.error(error?.data?.message || '删除失败');
        } finally {
            LoadingManager.hide();
        }
    }

    async saveAddressFromForm() {
        const form = document.getElementById('address-form');
        const getVal = (name) => form.querySelector(`[name="${name}"]`).value.trim();
        const payload = {
            recipient_name: getVal('recipient_name'),
            phone: getVal('phone'),
            city: getVal('city'),
            district: getVal('district'),
            detail: getVal('detail'),
            is_default: form.querySelector('[name="is_default"]').checked,
        };

        if (!payload.recipient_name || !payload.phone || !payload.city || !payload.district || !payload.detail) {
            NotificationManager.error('请完整填写地址信息');
            return;
        }

        LoadingManager.show('正在保存地址...');
        try {
            const resp = await API.address.add(payload);
            if (resp.data) {
                const saved = {
                    ...resp.data,
                    full_address: `${resp.data.city || ''}${resp.data.district || ''}${resp.data.detail || ''}`
                };
                let next = [saved, ...this.addresses];
                if (saved.is_default) {
                    next = next.map(addr => ({ ...addr, is_default: addr.id === saved.id }));
                }
                this.addresses = next;
                this.renderAddresses();
                this.toggleAddressForm(false);
                NotificationManager.success('地址已添加');
            }
        } catch (error) {
            NotificationManager.error(error?.data?.message || '保存失败');
        } finally {
            LoadingManager.hide();
        }
    }

    toggleAddressForm(show) {
        const form = document.getElementById('address-form');
        form.style.display = show ? 'block' : 'none';
        if (!show) {
            form.querySelectorAll('input').forEach(input => {
                if (input.type === 'checkbox') {
                    input.checked = false;
                } else {
                    input.value = '';
                }
            });
        }
    }

    setupEventListeners() {
        // 标签页切换
        document.querySelectorAll('.tab-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const tabName = e.currentTarget.getAttribute('href').slice(1);

                document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('is-active'));
                document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');

                e.currentTarget.classList.add('is-active');
                document.getElementById(tabName + '-tab').style.display = 'block';
            });
        });

        // 编辑资料弹窗
        document.getElementById('edit-profile-btn').addEventListener('click', () => this.showEditModal());
        document.getElementById('cancel-edit-btn').addEventListener('click', () => this.hideEditModal());
        document.getElementById('close-edit-modal').addEventListener('click', () => this.hideEditModal());
        document.getElementById('save-edit-btn').addEventListener('click', () => this.saveProfileFromModal());

        // 地址表单
        document.getElementById('add-address-btn').addEventListener('click', () => this.toggleAddressForm(true));
        document.getElementById('cancel-address-btn').addEventListener('click', () => this.toggleAddressForm(false));
        document.getElementById('save-address-btn').addEventListener('click', () => this.saveAddressFromForm());

        // 更换头像
        document.getElementById('change-avatar-btn').addEventListener('click', () => {
            document.getElementById('avatar-file-input').click();
        });

        document.getElementById('avatar-file-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                await this.uploadAvatar(file);
                e.target.value = '';
            }
        });

        // 修改密码
        document.getElementById('change-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            NotificationManager.info('修改密码功能开发中');
        });

        // 删除账户
        document.getElementById('delete-account-btn').addEventListener('click', () => {
            if (confirm('确定要删除账户吗？此操作无法撤销。')) {
                NotificationManager.info('删除账户功能开发中');
            }
        });
    }

    async uploadAvatar(file) {
        LoadingManager.show('正在上传头像...');
        try {
            const uploadResp = await API.upload.uploadImage(file, 'avatar');
            const url = uploadResp.data?.url;
            if (!url) throw new Error('上传失败');
            await API.user.updateProfile({ avatar: url });
            await this.loadUserData();
            NotificationManager.success('头像已更新');
        } catch (error) {
            NotificationManager.error(error?.data?.message || '上传失败');
        } finally {
            LoadingManager.hide();
        }
    }
}

// 初始化
document.addEventListener('DOMContentLoaded', () => {
    new ProfilePage();
});
</script>
{% endblock %}
